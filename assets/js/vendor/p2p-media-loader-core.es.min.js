var __defProp=Object.defineProperty,__defNormalProp=(e,t,n)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,__publicField=(e,t,n)=>__defNormalProp(e,"symbol"!=typeof t?t+"":t,n);class RequestError extends Error{constructor(e,t){super(t),__publicField(this,"timestamp"),this.type=e,this.timestamp=performance.now()}}class CoreRequestError extends Error{constructor(e){super(),this.type=e}}class HttpRequestExecutor{constructor(e,t,n){__publicField(this,"requestControls"),__publicField(this,"abortController",new AbortController),__publicField(this,"expectedBytesLength"),__publicField(this,"requestByteRange"),__publicField(this,"onChunkDownloaded"),this.request=e,this.httpConfig=t,this.onChunkDownloaded=n.getEventDispatcher("onChunkDownloaded");t=this.request.segment.byteRange;t&&(this.requestByteRange={...t}),0!==e.loadedBytes&&(this.requestByteRange=this.requestByteRange??{start:0},this.requestByteRange.start=this.requestByteRange.start+e.loadedBytes),this.request.totalBytes&&(this.expectedBytesLength=this.request.totalBytes-this.request.loadedBytes),this.requestControls=this.request.start({downloadSource:"http"},{abort:()=>this.abortController.abort("abort"),notReceivingBytesTimeoutMs:this.httpConfig.httpNotReceivingBytesTimeoutMs}),this.fetch()}async fetch(){var t,n,r,s=this.request["segment"];try{let e=await(null==(n=(t=this.httpConfig).httpRequestSetup)?void 0:n.call(t,s.url,s.byteRange,this.abortController.signal,this.requestByteRange));if(e||(r=new Headers(this.requestByteRange?{Range:`bytes=${this.requestByteRange.start}-`+(this.requestByteRange.end??"")}:void 0),e=new Request(s.url,{headers:r,signal:this.abortController.signal})),this.abortController.signal.aborted)throw new DOMException("Request aborted before request fetch","AbortError");const i=await window.fetch(e);if(this.handleResponseHeaders(i),!i.body)return;const o=this["requestControls"];o.firstBytesReceived();for await(const a of readStream(i.body.getReader()))this.requestControls.addLoadedChunk(a),this.onChunkDownloaded(a.byteLength,"http");o.completeOnSuccess()}catch(e){this.handleError(e)}}handleResponseHeaders(e){if(!e.ok)throw 406===e.status?(this.request.clearLoadedBytes(),new RequestError("http-bytes-mismatch",e.statusText)):new RequestError("http-error",e.statusText);var t=this["requestByteRange"];if(t)if(200===e.status){if(this.request.segment.byteRange)throw new RequestError("http-unexpected-status-code");this.request.clearLoadedBytes()}else{if(206!==e.status)throw new RequestError("http-unexpected-status-code",e.statusText);var n=e.headers.get("Content-Length");if(n&&void 0!==this.expectedBytesLength&&this.expectedBytesLength!==+n)throw this.request.clearLoadedBytes(),new RequestError("http-bytes-mismatch",e.statusText);n=e.headers.get("Content-Range"),n=n?parseContentRangeHeader(n):void 0;if(n){var{from:n,to:r,total:s}=n;if(void 0!==s&&this.request.totalBytes!==s||void 0!==n&&t.start!==n||void 0!==r&&void 0!==t.end&&t.end!==r)throw this.request.clearLoadedBytes(),new RequestError("http-bytes-mismatch",e.statusText)}}200===e.status&&void 0===this.request.totalBytes&&(s=e.headers.get("Content-Length"))&&this.request.setTotalBytes(+s)}handleError(e){e instanceof Error&&"abort"===e.name&&(e=e instanceof RequestError?e:new RequestError("http-error",e.message),this.requestControls.abortOnError(e))}}async function*readStream(e){for(;;){var{done:t,value:n}=await e.read();if(t)break;yield n}}function parseContentRangeHeader(e){var t,n,e=e.trim().match(/^bytes (?:(?:(\d+)|)-(?:(\d+)|)|\*)\/(?:(\d+)|\*)$/);if(e)return[,e,t,n]=e,{from:e?parseInt(e):void 0,to:t?parseInt(t):void 0,total:n?parseInt(n):void 0}}function getDefaultExportFromCjs$1(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var cachedSetTimeout,cachedClearTimeout,browser$1={exports:{}},process=browser$1.exports={};function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}try{cachedSetTimeout="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(e){cachedSetTimeout=defaultSetTimout}try{cachedClearTimeout="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(e){cachedClearTimeout=defaultClearTimeout}function runTimeout(t){if(cachedSetTimeout===setTimeout)return setTimeout(t,0);if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout)return(cachedSetTimeout=setTimeout)(t,0);try{return cachedSetTimeout(t,0)}catch(e){try{return cachedSetTimeout.call(null,t,0)}catch(e){return cachedSetTimeout.call(this,t,0)}}}function runClearTimeout(t){if(cachedClearTimeout===clearTimeout)return clearTimeout(t);if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout)return(cachedClearTimeout=clearTimeout)(t);try{return cachedClearTimeout(t)}catch(e){try{return cachedClearTimeout.call(null,t)}catch(e){return cachedClearTimeout.call(this,t)}}}var currentQueue,queue=[],draining=!1,queueIndex=-1;function cleanUpNextTick(){draining&&currentQueue&&(draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue())}function drainQueue(){if(!draining){for(var e=runTimeout(cleanUpNextTick),t=(draining=!0,queue.length);t;){for(currentQueue=queue,queue=[];++queueIndex<t;)currentQueue&&currentQueue[queueIndex].run();queueIndex=-1,t=queue.length}currentQueue=null,draining=!1,runClearTimeout(e)}}function Item(e,t){this.fun=e,this.array=t}function noop$2(){}process.nextTick=function(e){var t=new Array(arguments.length-1);if(1<arguments.length)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];queue.push(new Item(e,t)),1!==queue.length||draining||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},process.title="browser",process.browser=!0,process.env={},process.argv=[],process.version="",process.versions={},process.on=noop$2,process.addListener=noop$2,process.once=noop$2,process.off=noop$2,process.removeListener=noop$2,process.removeAllListeners=noop$2,process.emit=noop$2,process.prependListener=noop$2,process.prependOnceListener=noop$2,process.listeners=function(e){return[]},process.binding=function(e){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(e){throw new Error("process.chdir is not supported")},process.umask=function(){return 0};var browserExports$1=browser$1.exports;const process$1=getDefaultExportFromCjs$1(browserExports$1);var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function getDefaultExportFromCjs(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var ms,hasRequiredMs,browser={exports:{}};function requireMs(){if(hasRequiredMs)return ms;hasRequiredMs=1;var s=1e3,i=60*s,o=60*i,a=24*o,d=7*a,h=365.25*a;function l(e,t,n,r){t=1.5*n<=t;return Math.round(e/n)+" "+r+(t?"s":"")}return ms=function(e,t){t=t||{};var n=typeof e;if(!("string"==n&&0<e.length)){if("number"==n&&isFinite(e))return(t.long?function(e){var t=Math.abs(e);if(a<=t)return l(e,t,a,"day");if(o<=t)return l(e,t,o,"hour");if(i<=t)return l(e,t,i,"minute");if(s<=t)return l(e,t,s,"second");return e+" ms"}:function(e){var t=Math.abs(e);if(a<=t)return Math.round(e/a)+"d";if(o<=t)return Math.round(e/o)+"h";if(i<=t)return Math.round(e/i)+"m";if(s<=t)return Math.round(e/s)+"s";return e+"ms"})(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}n=e;if(!(100<(n=String(n)).length)){n=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(n);if(n){var r=parseFloat(n[1]);switch((n[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return r*h;case"weeks":case"week":case"w":return r*d;case"days":case"day":case"d":return r*a;case"hours":case"hour":case"hrs":case"hr":case"h":return r*o;case"minutes":case"minute":case"mins":case"min":case"m":return r*i;case"seconds":case"second":case"secs":case"sec":case"s":return r*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return r;default:return}}}}}function setup(t){function d(e){let o,t=null,n,r;function a(...s){if(a.enabled){const i=a;var e=Number(new Date),t=e-(o||e);i.diff=t,i.prev=o,i.curr=e,o=e,s[0]=d.coerce(s[0]),"string"!=typeof s[0]&&s.unshift("%O");let r=0;s[0]=s[0].replace(/%([a-zA-Z%])/g,(e,t)=>{if("%%"===e)return"%";r++;const n=d.formatters[t];return"function"==typeof n&&(t=s[r],e=n.call(i,t),s.splice(r,1),r--),e}),d.formatArgs.call(i,s);const n=i.log||d.log;n.apply(i,s)}}return a.namespace=e,a.useColors=d.useColors(),a.color=d.selectColor(e),a.extend=s,a.destroy=d.destroy,Object.defineProperty(a,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==t?t:(n!==d.namespaces&&(n=d.namespaces,r=d.enabled(e)),r),set:e=>{t=e}}),"function"==typeof d.init&&d.init(a),a}function s(e,t){const n=d(this.namespace+(void 0===t?":":t)+e);return n.log=this.log,n}function n(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return((d.debug=d).default=d).coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},d.disable=function(){var e=[...d.names.map(n),...d.skips.map(n).map(e=>"-"+e)].join(",");return d.enable(""),e},d.enable=function(e){d.save(e),d.namespaces=e,d.names=[],d.skips=[];let t;const n=("string"==typeof e?e:"").split(/[\s,]+/),r=n.length;for(t=0;t<r;t++)n[t]&&("-"===(e=n[t].replace(/\*/g,".*?"))[0]?d.skips.push(new RegExp("^"+e.slice(1)+"$")):d.names.push(new RegExp("^"+e+"$")))},d.enabled=function(e){if("*"===e[e.length-1])return!0;let t,n;for(t=0,n=d.skips.length;t<n;t++)if(d.skips[t].test(e))return!1;for(t=0,n=d.names.length;t<n;t++)if(d.names[t].test(e))return!0;return!1},d.humanize=requireMs(),d.destroy=function(){},Object.keys(t).forEach(e=>{d[e]=t[e]}),d.names=[],d.skips=[],d.formatters={},d.selectColor=function(t){let n=0;for(let e=0;e<t.length;e++)n=(n<<5)-n+t.charCodeAt(e),n|=0;return d.colors[Math.abs(n)%d.colors.length]},d.enable(d.load()),d}var common$2=setup,browserExports=(!function(t,n){n.formatArgs=function(e){if(e[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+e[0]+(this.useColors?"%c ":" ")+"+"+t.exports.humanize(this.diff),this.useColors){var r="color: "+this.color;e.splice(1,0,r,"color: inherit");let t=0,n=0;e[0].replace(/%[a-zA-Z%]/g,e=>{"%%"!==e&&(t++,"%c"===e&&(n=t))}),e.splice(n,0,r)}},n.save=function(e){try{e?n.storage.setItem("debug",e):n.storage.removeItem("debug")}catch(e){}},n.load=function(){let e;try{e=n.storage.getItem("debug")}catch(e){}!e&&void 0!==process$1&&"env"in process$1&&(e=process$1.env.DEBUG);return e},n.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let e;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&(e=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&31<=parseInt(e[1],10)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},n.storage=function(){try{return localStorage}catch(e){}}(),n.destroy=(()=>{let e=!1;return()=>{e=e||!0}})(),n.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],n.log=console.debug||console.log||(()=>{}),t.exports=common$2(n);const e=t.exports["formatters"];e.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}(browser,browser.exports),browser.exports);const debug$3=getDefaultExportFromCjs(browserExports);var events={exports:{}},R="object"==typeof Reflect?Reflect:null,ReflectApply=R&&"function"==typeof R.apply?R.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};function ProcessEmitWarning(e){console&&console}var ReflectOwnKeys=R&&"function"==typeof R.ownKeys?R.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)},NumberIsNaN=Number.isNaN||function(e){return e!=e};function EventEmitter$1(){EventEmitter$1.init.call(this)}events.exports=EventEmitter$1,events.exports.once=once$3,(EventEmitter$1.EventEmitter=EventEmitter$1).prototype._events=void 0,EventEmitter$1.prototype._eventsCount=0,EventEmitter$1.prototype._maxListeners=void 0;var defaultMaxListeners=10;function checkListener(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function _getMaxListeners(e){return void 0===e._maxListeners?EventEmitter$1.defaultMaxListeners:e._maxListeners}function _addListener(e,t,n,r){var s,i;return checkListener(n),void 0===(s=e._events)?(s=e._events=Object.create(null),e._eventsCount=0):(void 0!==s.newListener&&(e.emit("newListener",t,n.listener||n),s=e._events),i=s[t]),void 0===i?(i=s[t]=n,++e._eventsCount):("function"==typeof i?i=s[t]=r?[n,i]:[i,n]:r?i.unshift(n):i.push(n),0<(s=_getMaxListeners(e))&&s<i.length&&!i.warned&&(i.warned=!0,(r=new Error("Possible EventEmitter memory leak detected. "+i.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit")).name="MaxListenersExceededWarning",r.emitter=e,r.type=t,r.count=i.length,ProcessEmitWarning(r))),e}function onceWrapper(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function _onceWrap(e,t,n){e={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},t=onceWrapper.bind(e);return t.listener=n,e.wrapFn=t}function _listeners(e,t,n){e=e._events;if(void 0===e)return[];e=e[t];return void 0===e?[]:"function"==typeof e?n?[e.listener||e]:[e]:n?unwrapListeners(e):arrayClone(e,e.length)}function listenerCount(e){var t=this._events;if(void 0!==t){t=t[e];if("function"==typeof t)return 1;if(void 0!==t)return t.length}return 0}function arrayClone(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}function spliceOne(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function unwrapListeners(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}function once$3(s,i){return new Promise(function(e,t){function n(e){s.removeListener(i,r),t(e)}function r(){"function"==typeof s.removeListener&&s.removeListener("error",n),e([].slice.call(arguments))}eventTargetAgnosticAddListener(s,i,r,{once:!0}),"error"!==i&&addErrorHandlerIfEventEmitter(s,n,{once:!0})})}function addErrorHandlerIfEventEmitter(e,t,n){"function"==typeof e.on&&eventTargetAgnosticAddListener(e,"error",t,n)}function eventTargetAgnosticAddListener(n,r,s,i){if("function"==typeof n.on)i.once?n.once(r,s):n.on(r,s);else{if("function"!=typeof n.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof n);n.addEventListener(r,function e(t){i.once&&n.removeEventListener(r,e),s(t)})}}Object.defineProperty(EventEmitter$1,"defaultMaxListeners",{enumerable:!0,get:function(){return defaultMaxListeners},set:function(e){if("number"!=typeof e||e<0||NumberIsNaN(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");defaultMaxListeners=e}}),EventEmitter$1.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},EventEmitter$1.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||NumberIsNaN(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},EventEmitter$1.prototype.getMaxListeners=function(){return _getMaxListeners(this)},EventEmitter$1.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var r="error"===e,s=this._events;if(void 0!==s)r=r&&void 0===s.error;else if(!r)return!1;if(r){if((i=0<t.length?t[0]:i)instanceof Error)throw i;r=new Error("Unhandled error."+(i?" ("+i.message+")":""));throw r.context=i,r}var i=s[e];if(void 0===i)return!1;if("function"==typeof i)ReflectApply(i,this,t);else for(var o=i.length,a=arrayClone(i,o),n=0;n<o;++n)ReflectApply(a[n],this,t);return!0},EventEmitter$1.prototype.addListener=function(e,t){return _addListener(this,e,t,!1)},EventEmitter$1.prototype.on=EventEmitter$1.prototype.addListener,EventEmitter$1.prototype.prependListener=function(e,t){return _addListener(this,e,t,!0)},EventEmitter$1.prototype.once=function(e,t){return checkListener(t),this.on(e,_onceWrap(this,e,t)),this},EventEmitter$1.prototype.prependOnceListener=function(e,t){return checkListener(t),this.prependListener(e,_onceWrap(this,e,t)),this},EventEmitter$1.prototype.removeListener=function(e,t){var n,r,s,i,o;if(checkListener(t),void 0===(r=this._events))return this;if(void 0===(n=r[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(s=-1,i=n.length-1;0<=i;i--)if(n[i]===t||n[i].listener===t){o=n[i].listener,s=i;break}if(s<0)return this;0===s?n.shift():spliceOne(n,s),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,o||t)}return this},EventEmitter$1.prototype.off=EventEmitter$1.prototype.removeListener,EventEmitter$1.prototype.removeAllListeners=function(e){var t,n=this._events;if(void 0===n)return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){for(var r,s=Object.keys(n),i=0;i<s.length;++i)"removeListener"!==(r=s[i])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(i=t.length-1;0<=i;i--)this.removeListener(e,t[i]);return this},EventEmitter$1.prototype.listeners=function(e){return _listeners(this,e,!0)},EventEmitter$1.prototype.rawListeners=function(e){return _listeners(this,e,!1)},EventEmitter$1.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):listenerCount.call(e,t)},EventEmitter$1.prototype.listenerCount=listenerCount,EventEmitter$1.prototype.eventNames=function(){return 0<this._eventsCount?ReflectOwnKeys(this._events):[]};var eventsExports=events.exports;const EventEmitter$2=getDefaultExportFromCjs(eventsExports);var once$2={exports:{}},wrappy_1=wrappy$1;function wrappy$1(s,e){if(s&&e)return wrappy$1(s)(e);if("function"!=typeof s)throw new TypeError("need wrapper function");return Object.keys(s).forEach(function(e){t[e]=s[e]}),t;function t(){for(var e=new Array(arguments.length),t=0;t<e.length;t++)e[t]=arguments[t];var n=s.apply(this,e),r=e[e.length-1];return"function"==typeof n&&n!==r&&Object.keys(r).forEach(function(e){n[e]=r[e]}),n}}var wrappy=wrappy$1;function once2(e){function t(){return t.called?t.value:(t.called=!0,t.value=e.apply(this,arguments))}return t.called=!1,t}function onceStrict(e){function t(){if(t.called)throw new Error(t.onceError);return t.called=!0,t.value=e.apply(this,arguments)}return t.onceError=(e.name||"Function wrapped with `once`")+" shouldn't be called more than once",t.called=!1,t}once$2.exports=wrappy(once2),once$2.exports.strict=wrappy(onceStrict),once2.proto=once2(function(){Object.defineProperty(Function.prototype,"once",{value:function(){return once2(this)},configurable:!0}),Object.defineProperty(Function.prototype,"onceStrict",{value:function(){return onceStrict(this)},configurable:!0})});var onceExports=once$2.exports;const once$1=getDefaultExportFromCjs(onceExports);let promise;var queueMicrotask_1$1="function"==typeof queueMicrotask?queueMicrotask.bind("undefined"!=typeof window?window:commonjsGlobal):e=>(promise=promise||Promise.resolve()).then(e).catch(e=>setTimeout(()=>{throw e},0));const queueMicrotask$2=getDefaultExportFromCjs(queueMicrotask_1$1);var runParallel_1=runParallel;const queueMicrotask$1=queueMicrotask_1$1;function runParallel(e,n){let r,s,t,i=!0;function o(e){function t(){n&&n(e,r),n=null}i?queueMicrotask$1(t):t()}function a(e,t,n){r[e]=n,0!=--s&&!t||o(t)}(s=Array.isArray(e)?(r=[],e.length):(t=Object.keys(e),r={},t.length))?t?t.forEach(function(n){e[n](function(e,t){a(n,e,t)})}):e.forEach(function(e,n){e(function(e,t){a(n,e,t)})}):o(null),i=!1}const parallel=getDefaultExportFromCjs(runParallel),scope$1="undefined"!=typeof window?window:self,RTCPeerConnection=scope$1.RTCPeerConnection||scope$1.mozRTCPeerConnection||scope$1.webkitRTCPeerConnection,RTCSessionDescription=scope$1.RTCSessionDescription||scope$1.mozRTCSessionDescription||scope$1.webkitRTCSessionDescription,RTCIceCandidate=scope$1.RTCIceCandidate||scope$1.mozRTCIceCandidate||scope$1.webkitRTCIceCandidate;var queueMicrotask_1="function"==typeof queueMicrotask?queueMicrotask:e=>Promise.resolve().then(e),fixedSize=class{constructor(e){if(!(0<e)||0!=(e-1&e))throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}clear(){this.top=this.btm=0,this.next=null,this.buffer.fill(void 0)}push(e){return void 0===this.buffer[this.top]&&(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){var e=this.buffer[this.btm];if(void 0!==e)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}peek(){return this.buffer[this.btm]}isEmpty(){return void 0===this.buffer[this.btm]}};const FixedFIFO2=fixedSize;var fastFifo=class{constructor(e){this.hwm=e||16,this.head=new FixedFIFO2(this.hwm),this.tail=this.head,this.length=0}clear(){this.head=this.tail,this.head.clear(),this.length=0}push(e){if(this.length++,!this.head.push(e)){const t=this.head;this.head=t.next=new FixedFIFO2(2*this.head.buffer.length),this.head.push(e)}}shift(){0!==this.length&&this.length--;var e,t=this.tail.shift();return void 0===t&&this.tail.next?(e=this.tail.next,this.tail.next=null,this.tail=e,this.tail.shift()):t}peek(){var e=this.tail.peek();return void 0===e&&this.tail.next?this.tail.next.peek():e}isEmpty(){return 0===this.length}},browserDecoder=class{constructor(e){this.decoder=new TextDecoder("utf16le"===e?"utf16-le":e)}get remaining(){return-1}decode(e){return this.decoder.decode(e,{stream:!0})}flush(){return this.decoder.decode(new Uint8Array(0))}};const PassThroughDecoder=browserDecoder,UTF8Decoder=browserDecoder;var textDecoder=class{constructor(e="utf8"){switch(this.encoding=normalizeEncoding(e),this.encoding){case"utf8":this.decoder=new UTF8Decoder;break;case"utf16le":case"base64":throw new Error("Unsupported encoding: "+this.encoding);default:this.decoder=new PassThroughDecoder(this.encoding)}}get remaining(){return this.decoder.remaining}push(e){return"string"==typeof e?e:this.decoder.decode(e)}write(e){return this.push(e)}end(e){let t="";return e&&(t=this.push(e)),t+=this.decoder.flush()}};function normalizeEncoding(e){switch(e=e.toLowerCase()){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return e;default:throw new Error("Unknown encoding: "+e)}}const EventEmitter=eventsExports["EventEmitter"],STREAM_DESTROYED=new Error("Stream was destroyed"),PREMATURE_CLOSE=new Error("Premature close"),queueTick=queueMicrotask_1,FIFO=fastFifo,TextDecoder$1=textDecoder,MAX=536870911,OPENING=1,PREDESTROYING=2,DESTROYING=4,DESTROYED=8,NOT_OPENING=MAX^OPENING,NOT_PREDESTROYING=MAX^PREDESTROYING,READ_ACTIVE=16,READ_UPDATING=32,READ_PRIMARY=64,READ_QUEUED=128,READ_RESUMED=256,READ_PIPE_DRAINED=512,READ_ENDING=1024,READ_EMIT_DATA=2048,READ_EMIT_READABLE=4096,READ_EMITTED_READABLE=8192,READ_DONE=16384,READ_NEXT_TICK=32768,READ_NEEDS_PUSH=65536,READ_READ_AHEAD=131072,READ_FLOWING=READ_RESUMED|READ_PIPE_DRAINED,READ_ACTIVE_AND_NEEDS_PUSH=READ_ACTIVE|READ_NEEDS_PUSH,READ_PRIMARY_AND_ACTIVE=READ_PRIMARY|READ_ACTIVE,READ_EMIT_READABLE_AND_QUEUED=READ_EMIT_READABLE|READ_QUEUED,READ_RESUMED_READ_AHEAD=READ_RESUMED|READ_READ_AHEAD,READ_NOT_ACTIVE=MAX^READ_ACTIVE,READ_NON_PRIMARY=MAX^READ_PRIMARY,READ_NON_PRIMARY_AND_PUSHED=MAX^(READ_PRIMARY|READ_NEEDS_PUSH),READ_PUSHED=MAX^READ_NEEDS_PUSH,READ_PAUSED=MAX^READ_RESUMED,READ_NOT_QUEUED=MAX^(READ_QUEUED|READ_EMITTED_READABLE),READ_NOT_ENDING=MAX^READ_ENDING,READ_PIPE_NOT_DRAINED=MAX^READ_FLOWING,READ_NOT_NEXT_TICK=MAX^READ_NEXT_TICK,READ_NOT_UPDATING=MAX^READ_UPDATING,READ_NO_READ_AHEAD=MAX^READ_READ_AHEAD,READ_PAUSED_NO_READ_AHEAD=MAX^READ_RESUMED_READ_AHEAD,WRITE_ACTIVE=1<<18,WRITE_UPDATING=2<<18,WRITE_PRIMARY=4<<18,WRITE_QUEUED=8<<18,WRITE_UNDRAINED=16<<18,WRITE_DONE=32<<18,WRITE_EMIT_DRAIN=64<<18,WRITE_NEXT_TICK=128<<18,WRITE_WRITING=256<<18,WRITE_FINISHING=512<<18,WRITE_CORKED=1024<<18,WRITE_NOT_ACTIVE=MAX^(WRITE_ACTIVE|WRITE_WRITING),WRITE_NON_PRIMARY=MAX^WRITE_PRIMARY,WRITE_NOT_FINISHING=MAX^WRITE_FINISHING,WRITE_DRAINED=MAX^WRITE_UNDRAINED,WRITE_NOT_QUEUED=MAX^WRITE_QUEUED,WRITE_NOT_NEXT_TICK=MAX^WRITE_NEXT_TICK,WRITE_NOT_UPDATING=MAX^WRITE_UPDATING,WRITE_NOT_CORKED=MAX^WRITE_CORKED,ACTIVE=READ_ACTIVE|WRITE_ACTIVE,NOT_ACTIVE=MAX^ACTIVE,DONE=READ_DONE|WRITE_DONE,DESTROY_STATUS=DESTROYING|DESTROYED|PREDESTROYING,OPEN_STATUS=DESTROY_STATUS|OPENING,AUTO_DESTROY=DESTROY_STATUS|DONE,NON_PRIMARY=WRITE_NON_PRIMARY&READ_NON_PRIMARY,ACTIVE_OR_TICKING=WRITE_NEXT_TICK|READ_NEXT_TICK,TICKING=ACTIVE_OR_TICKING&NOT_ACTIVE,IS_OPENING=OPEN_STATUS|TICKING,READ_PRIMARY_STATUS=OPEN_STATUS|READ_ENDING|READ_DONE,READ_STATUS=OPEN_STATUS|READ_DONE|READ_QUEUED,READ_ENDING_STATUS=OPEN_STATUS|READ_ENDING|READ_QUEUED,READ_READABLE_STATUS=OPEN_STATUS|READ_EMIT_READABLE|READ_QUEUED|READ_EMITTED_READABLE,SHOULD_NOT_READ=OPEN_STATUS|READ_ACTIVE|READ_ENDING|READ_DONE|READ_NEEDS_PUSH|READ_READ_AHEAD,READ_BACKPRESSURE_STATUS=DESTROY_STATUS|READ_ENDING|READ_DONE,READ_UPDATE_SYNC_STATUS=READ_UPDATING|OPEN_STATUS|READ_NEXT_TICK|READ_PRIMARY,WRITE_PRIMARY_STATUS=OPEN_STATUS|WRITE_FINISHING|WRITE_DONE,WRITE_QUEUED_AND_UNDRAINED=WRITE_QUEUED|WRITE_UNDRAINED,WRITE_QUEUED_AND_ACTIVE=WRITE_QUEUED|WRITE_ACTIVE,WRITE_DRAIN_STATUS=WRITE_QUEUED|WRITE_UNDRAINED|OPEN_STATUS|WRITE_ACTIVE,WRITE_STATUS=OPEN_STATUS|WRITE_ACTIVE|WRITE_QUEUED|WRITE_CORKED,WRITE_PRIMARY_AND_ACTIVE=WRITE_PRIMARY|WRITE_ACTIVE,WRITE_ACTIVE_AND_WRITING=WRITE_ACTIVE|WRITE_WRITING,WRITE_FINISHING_STATUS=OPEN_STATUS|WRITE_FINISHING|WRITE_QUEUED_AND_ACTIVE|WRITE_DONE,WRITE_BACKPRESSURE_STATUS=WRITE_UNDRAINED|DESTROY_STATUS|WRITE_FINISHING|WRITE_DONE,WRITE_UPDATE_SYNC_STATUS=WRITE_UPDATING|OPEN_STATUS|WRITE_NEXT_TICK|WRITE_PRIMARY,asyncIterator=Symbol.asyncIterator||Symbol("asyncIterator");class WritableState{constructor(e,{highWaterMark:t=16384,map:n=null,mapWritable:r,byteLength:s,byteLengthWritable:i}={}){this.stream=e,this.queue=new FIFO,this.highWaterMark=t,this.buffered=0,this.error=null,this.pipeline=null,this.drains=null,this.byteLength=i||s||defaultByteLength,this.map=r||n,this.afterWrite=afterWrite.bind(this),this.afterUpdateNextTick=updateWriteNT.bind(this)}get ended(){return 0!=(this.stream._duplexState&WRITE_DONE)}push(e){return null!==this.map&&(e=this.map(e)),this.buffered+=this.byteLength(e),this.queue.push(e),this.buffered<this.highWaterMark?(this.stream._duplexState|=WRITE_QUEUED,!0):(this.stream._duplexState|=WRITE_QUEUED_AND_UNDRAINED,!1)}shift(){var e=this.queue.shift();return this.buffered-=this.byteLength(e),0===this.buffered&&(this.stream._duplexState&=WRITE_NOT_QUEUED),e}end(e){"function"==typeof e?this.stream.once("finish",e):null!=e&&this.push(e),this.stream._duplexState=(this.stream._duplexState|WRITE_FINISHING)&WRITE_NON_PRIMARY}autoBatch(e,t){const n=[],r=this.stream;for(n.push(e);(r._duplexState&WRITE_STATUS)===WRITE_QUEUED_AND_ACTIVE;)n.push(r._writableState.shift());if(0!=(r._duplexState&OPEN_STATUS))return t(null);r._writev(n,t)}update(){const e=this.stream;e._duplexState|=WRITE_UPDATING;do{for(;(e._duplexState&WRITE_STATUS)===WRITE_QUEUED;){var t=this.shift();e._duplexState|=WRITE_ACTIVE_AND_WRITING,e._write(t,this.afterWrite)}}while(0==(e._duplexState&WRITE_PRIMARY_AND_ACTIVE)&&this.updateNonPrimary(),!0===this.continueUpdate());e._duplexState&=WRITE_NOT_UPDATING}updateNonPrimary(){const e=this.stream;if((e._duplexState&WRITE_FINISHING_STATUS)===WRITE_FINISHING)return e._duplexState=(e._duplexState|WRITE_ACTIVE)&WRITE_NOT_FINISHING,void e._final(afterFinal.bind(this));(e._duplexState&DESTROY_STATUS)===DESTROYING?0==(e._duplexState&ACTIVE_OR_TICKING)&&(e._duplexState|=ACTIVE,e._destroy(afterDestroy.bind(this))):(e._duplexState&IS_OPENING)===OPENING&&(e._duplexState=(e._duplexState|ACTIVE)&NOT_OPENING,e._open(afterOpen.bind(this)))}continueUpdate(){return 0!=(this.stream._duplexState&WRITE_NEXT_TICK)&&(this.stream._duplexState&=WRITE_NOT_NEXT_TICK,!0)}updateCallback(){(this.stream._duplexState&WRITE_UPDATE_SYNC_STATUS)===WRITE_PRIMARY?this.update():this.updateNextTick()}updateNextTick(){0==(this.stream._duplexState&WRITE_NEXT_TICK)&&(this.stream._duplexState|=WRITE_NEXT_TICK,0==(this.stream._duplexState&WRITE_UPDATING)&&queueTick(this.afterUpdateNextTick))}}class ReadableState{constructor(e,{highWaterMark:t=16384,map:n=null,mapReadable:r,byteLength:s,byteLengthReadable:i}={}){this.stream=e,this.queue=new FIFO,this.highWaterMark=0===t?1:t,this.buffered=0,this.readAhead=0<t,this.error=null,this.pipeline=null,this.byteLength=i||s||defaultByteLength,this.map=r||n,this.pipeTo=null,this.afterRead=afterRead.bind(this),this.afterUpdateNextTick=updateReadNT.bind(this)}get ended(){return 0!=(this.stream._duplexState&READ_DONE)}pipe(e,t){if(null!==this.pipeTo)throw new Error("Can only pipe to one destination");var n;"function"!=typeof t&&(t=null),this.stream._duplexState|=READ_PIPE_DRAINED,this.pipeTo=e,this.pipeline=new Pipeline(this.stream,e,t),t&&this.stream.on("error",noop$1),isStreamx(e)?(e._writableState.pipeline=this.pipeline,t&&e.on("error",noop$1)):(t=this.pipeline.done.bind(this.pipeline,e),n=this.pipeline.done.bind(this.pipeline,e,null),e.on("error",t),e.on("close",n)),e.on("finish",this.pipeline.finished.bind(this.pipeline)),e.on("drain",afterDrain.bind(this)),this.stream.emit("piping",e),e.emit("pipe",this.stream)}push(e){const t=this.stream;return null===e?(this.highWaterMark=0,t._duplexState=(t._duplexState|READ_ENDING)&READ_NON_PRIMARY_AND_PUSHED,!1):(null!==this.map&&null===(e=this.map(e))?t._duplexState&=READ_PUSHED:(this.buffered+=this.byteLength(e),this.queue.push(e),t._duplexState=(t._duplexState|READ_QUEUED)&READ_PUSHED),this.buffered<this.highWaterMark)}shift(){var e=this.queue.shift();return this.buffered-=this.byteLength(e),0===this.buffered&&(this.stream._duplexState&=READ_NOT_QUEUED),e}unshift(e){const t=[null!==this.map?this.map(e):e];for(;0<this.buffered;)t.push(this.shift());for(let e=0;e<t.length-1;e++){var n=t[e];this.buffered+=this.byteLength(n),this.queue.push(n)}this.push(t[t.length-1])}read(){const e=this.stream;var t;return(e._duplexState&READ_STATUS)===READ_QUEUED?(t=this.shift(),null!==this.pipeTo&&!1===this.pipeTo.write(t)&&(e._duplexState&=READ_PIPE_NOT_DRAINED),0!=(e._duplexState&READ_EMIT_DATA)&&e.emit("data",t),t):(!1===this.readAhead&&(e._duplexState|=READ_READ_AHEAD,this.updateNextTick()),null)}drain(){const e=this.stream;for(;(e._duplexState&READ_STATUS)===READ_QUEUED&&0!=(e._duplexState&READ_FLOWING);){var t=this.shift();null!==this.pipeTo&&!1===this.pipeTo.write(t)&&(e._duplexState&=READ_PIPE_NOT_DRAINED),0!=(e._duplexState&READ_EMIT_DATA)&&e.emit("data",t)}}update(){const e=this.stream;e._duplexState|=READ_UPDATING;do{for(this.drain();this.buffered<this.highWaterMark&&(e._duplexState&SHOULD_NOT_READ)===READ_READ_AHEAD;)e._duplexState|=READ_ACTIVE_AND_NEEDS_PUSH,e._read(this.afterRead),this.drain()}while((e._duplexState&READ_READABLE_STATUS)===READ_EMIT_READABLE_AND_QUEUED&&(e._duplexState|=READ_EMITTED_READABLE,e.emit("readable")),0==(e._duplexState&READ_PRIMARY_AND_ACTIVE)&&this.updateNonPrimary(),!0===this.continueUpdate());e._duplexState&=READ_NOT_UPDATING}updateNonPrimary(){const e=this.stream;(e._duplexState&READ_ENDING_STATUS)===READ_ENDING&&(e._duplexState=(e._duplexState|READ_DONE)&READ_NOT_ENDING,e.emit("end"),(e._duplexState&AUTO_DESTROY)===DONE&&(e._duplexState|=DESTROYING),null!==this.pipeTo&&this.pipeTo.end()),(e._duplexState&DESTROY_STATUS)===DESTROYING?0==(e._duplexState&ACTIVE_OR_TICKING)&&(e._duplexState|=ACTIVE,e._destroy(afterDestroy.bind(this))):(e._duplexState&IS_OPENING)===OPENING&&(e._duplexState=(e._duplexState|ACTIVE)&NOT_OPENING,e._open(afterOpen.bind(this)))}continueUpdate(){return 0!=(this.stream._duplexState&READ_NEXT_TICK)&&(this.stream._duplexState&=READ_NOT_NEXT_TICK,!0)}updateCallback(){(this.stream._duplexState&READ_UPDATE_SYNC_STATUS)===READ_PRIMARY?this.update():this.updateNextTick()}updateNextTick(){0==(this.stream._duplexState&READ_NEXT_TICK)&&(this.stream._duplexState|=READ_NEXT_TICK,0==(this.stream._duplexState&READ_UPDATING)&&queueTick(this.afterUpdateNextTick))}}class TransformState{constructor(e){this.data=null,this.afterTransform=afterTransform.bind(e),this.afterFinal=null}}class Pipeline{constructor(e,t,n){this.from=e,this.to=t,this.afterPipe=n,this.error=null,this.pipeToFinished=!1}finished(){this.pipeToFinished=!0}done(e,t){t&&(this.error=t),e===this.to&&(this.to=null)!==this.from?0!=(this.from._duplexState&READ_DONE)&&this.pipeToFinished||this.from.destroy(this.error||new Error("Writable stream closed prematurely")):e===this.from&&(this.from=null)!==this.to?0==(e._duplexState&READ_DONE)&&this.to.destroy(this.error||new Error("Readable stream closed before ending")):(null!==this.afterPipe&&this.afterPipe(this.error),this.to=this.from=this.afterPipe=null)}}function afterDrain(){this.stream._duplexState|=READ_PIPE_DRAINED,this.updateCallback()}function afterFinal(e){const t=this.stream;e&&t.destroy(e),0==(t._duplexState&DESTROY_STATUS)&&(t._duplexState|=WRITE_DONE,t.emit("finish")),(t._duplexState&AUTO_DESTROY)===DONE&&(t._duplexState|=DESTROYING),t._duplexState&=WRITE_NOT_ACTIVE,0==(t._duplexState&WRITE_UPDATING)?this.update():this.updateNextTick()}function afterDestroy(e){const t=this.stream,n=((e=e||this.error===STREAM_DESTROYED?e:this.error)&&t.emit("error",e),t._duplexState|=DESTROYED,t.emit("close"),t._readableState),r=t._writableState;if(null!==n&&null!==n.pipeline&&n.pipeline.done(t,e),null!==r){for(;null!==r.drains&&0<r.drains.length;)r.drains.shift().resolve(!1);null!==r.pipeline&&r.pipeline.done(t,e)}}function afterWrite(e){const t=this.stream;e&&t.destroy(e),t._duplexState&=WRITE_NOT_ACTIVE,null!==this.drains&&tickDrains(this.drains),(t._duplexState&WRITE_DRAIN_STATUS)===WRITE_UNDRAINED&&(t._duplexState&=WRITE_DRAINED,(t._duplexState&WRITE_EMIT_DRAIN)===WRITE_EMIT_DRAIN&&t.emit("drain")),this.updateCallback()}function afterRead(e){e&&this.stream.destroy(e),this.stream._duplexState&=READ_NOT_ACTIVE,!1===this.readAhead&&0==(this.stream._duplexState&READ_RESUMED)&&(this.stream._duplexState&=READ_NO_READ_AHEAD),this.updateCallback()}function updateReadNT(){0==(this.stream._duplexState&READ_UPDATING)&&(this.stream._duplexState&=READ_NOT_NEXT_TICK,this.update())}function updateWriteNT(){0==(this.stream._duplexState&WRITE_UPDATING)&&(this.stream._duplexState&=WRITE_NOT_NEXT_TICK,this.update())}function tickDrains(t){for(let e=0;e<t.length;e++)0==--t[e].writes&&(t.shift().resolve(!0),e--)}function afterOpen(e){const t=this.stream;e&&t.destroy(e),0==(t._duplexState&DESTROYING)&&(0==(t._duplexState&READ_PRIMARY_STATUS)&&(t._duplexState|=READ_PRIMARY),0==(t._duplexState&WRITE_PRIMARY_STATUS)&&(t._duplexState|=WRITE_PRIMARY),t.emit("open")),t._duplexState&=NOT_ACTIVE,null!==t._writableState&&t._writableState.updateCallback(),null!==t._readableState&&t._readableState.updateCallback()}function afterTransform(e,t){null!=t&&this.push(t),this._writableState.afterWrite(e)}function newListener(e){null!==this._readableState&&("data"===e&&(this._duplexState|=READ_EMIT_DATA|READ_RESUMED_READ_AHEAD,this._readableState.updateNextTick()),"readable"===e&&(this._duplexState|=READ_EMIT_READABLE,this._readableState.updateNextTick())),null!==this._writableState&&"drain"===e&&(this._duplexState|=WRITE_EMIT_DRAIN,this._writableState.updateNextTick())}class Stream extends EventEmitter{constructor(e){super(),this._duplexState=0,this._readableState=null,this._writableState=null,e&&(e.open&&(this._open=e.open),e.destroy&&(this._destroy=e.destroy),e.predestroy&&(this._predestroy=e.predestroy),e.signal&&e.signal.addEventListener("abort",abort.bind(this))),this.on("newListener",newListener)}_open(e){e(null)}_destroy(e){e(null)}_predestroy(){}get readable(){return null!==this._readableState||void 0}get writable(){return null!==this._writableState||void 0}get destroyed(){return 0!=(this._duplexState&DESTROYED)}get destroying(){return 0!=(this._duplexState&DESTROY_STATUS)}destroy(e){0==(this._duplexState&DESTROY_STATUS)&&(e=e||STREAM_DESTROYED,this._duplexState=(this._duplexState|DESTROYING)&NON_PRIMARY,null!==this._readableState&&(this._readableState.highWaterMark=0,this._readableState.error=e),null!==this._writableState&&(this._writableState.highWaterMark=0,this._writableState.error=e),this._duplexState|=PREDESTROYING,this._predestroy(),this._duplexState&=NOT_PREDESTROYING,null!==this._readableState&&this._readableState.updateNextTick(),null!==this._writableState&&this._writableState.updateNextTick())}}class Readable extends Stream{constructor(e){super(e),this._duplexState|=OPENING|WRITE_DONE|READ_READ_AHEAD,this._readableState=new ReadableState(this,e),e&&(!1===this._readableState.readAhead&&(this._duplexState&=READ_NO_READ_AHEAD),e.read&&(this._read=e.read),e.eagerOpen&&this._readableState.updateNextTick(),e.encoding&&this.setEncoding(e.encoding))}setEncoding(e){const n=new TextDecoder$1(e),r=this._readableState.map||echo;return this._readableState.map=function(e){var t=n.push(e);return""===t&&(0!==e.byteLength||0<n.remaining)?null:r(t)},this}_read(e){e(null)}pipe(e,t){return this._readableState.updateNextTick(),this._readableState.pipe(e,t),e}read(){return this._readableState.updateNextTick(),this._readableState.read()}push(e){return this._readableState.updateNextTick(),this._readableState.push(e)}unshift(e){return this._readableState.updateNextTick(),this._readableState.unshift(e)}resume(){return this._duplexState|=READ_RESUMED_READ_AHEAD,this._readableState.updateNextTick(),this}pause(){return this._duplexState&=!1===this._readableState.readAhead?READ_PAUSED_NO_READ_AHEAD:READ_PAUSED,this}static _fromAsyncIterator(t,e){let n;const r=new Readable({...e,read(e){t.next().then(s).then(e.bind(null,null)).catch(e)},predestroy(){n=t.return()},destroy(e){if(!n)return e(null);n.then(e.bind(null,null)).catch(e)}});return r;function s(e){e.done?r.push(null):r.push(e.value)}}static from(t,e){if(isReadStreamx(t))return t;if(t[asyncIterator])return this._fromAsyncIterator(t[asyncIterator](),e);Array.isArray(t)||(t=void 0===t?[]:[t]);let n=0;return new Readable({...e,read(e){this.push(n===t.length?null:t[n++]),e(null)}})}static isBackpressured(e){return 0!=(e._duplexState&READ_BACKPRESSURE_STATUS)||e._readableState.highWaterMark<=e._readableState.buffered}static isPaused(e){return 0==(e._duplexState&READ_RESUMED)}[asyncIterator](){const r=this;let t=null,n=null,s=null;return this.on("error",e=>{t=e}),this.on("readable",function(){null!==n&&i(r.read())}),this.on("close",function(){null!==n&&i(null)}),{[asyncIterator](){return this},next(){return new Promise(function(e,t){n=e,s=t;e=r.read();null!==e?i(e):0!=(r._duplexState&DESTROYED)&&i(null)})},return(){return o(null)},throw(e){return o(e)}};function i(e){null!==s&&(t?s(t):null===e&&0==(r._duplexState&READ_DONE)?s(STREAM_DESTROYED):n({value:e,done:null===e}),s=n=null)}function o(n){return r.destroy(n),new Promise((e,t)=>{if(r._duplexState&DESTROYED)return e({value:void 0,done:!0});r.once("close",function(){n?t(n):e({value:void 0,done:!0})})})}}}class Writable extends Stream{constructor(e){super(e),this._duplexState|=OPENING|READ_DONE,this._writableState=new WritableState(this,e),e&&(e.writev&&(this._writev=e.writev),e.write&&(this._write=e.write),e.final&&(this._final=e.final),e.eagerOpen&&this._writableState.updateNextTick())}cork(){this._duplexState|=WRITE_CORKED}uncork(){this._duplexState&=WRITE_NOT_CORKED,this._writableState.updateNextTick()}_writev(e,t){t(null)}_write(e,t){this._writableState.autoBatch(e,t)}_final(e){e(null)}static isBackpressured(e){return 0!=(e._duplexState&WRITE_BACKPRESSURE_STATUS)}static drained(e){if(e.destroyed)return Promise.resolve(!1);const t=e._writableState;const n=(isWritev(e)?Math.min(1,t.queue.length):t.queue.length)+(e._duplexState&WRITE_WRITING?1:0);return 0===n?Promise.resolve(!0):(null===t.drains&&(t.drains=[]),new Promise(e=>{t.drains.push({writes:n,resolve:e})}))}write(e){return this._writableState.updateNextTick(),this._writableState.push(e)}end(e){return this._writableState.updateNextTick(),this._writableState.end(e),this}}class Duplex extends Readable{constructor(e){super(e),this._duplexState=OPENING|this._duplexState&READ_READ_AHEAD,this._writableState=new WritableState(this,e),e&&(e.writev&&(this._writev=e.writev),e.write&&(this._write=e.write),e.final&&(this._final=e.final))}cork(){this._duplexState|=WRITE_CORKED}uncork(){this._duplexState&=WRITE_NOT_CORKED,this._writableState.updateNextTick()}_writev(e,t){t(null)}_write(e,t){this._writableState.autoBatch(e,t)}_final(e){e(null)}write(e){return this._writableState.updateNextTick(),this._writableState.push(e)}end(e){return this._writableState.updateNextTick(),this._writableState.end(e),this}}class Transform extends Duplex{constructor(e){super(e),this._transformState=new TransformState(this),e&&(e.transform&&(this._transform=e.transform),e.flush&&(this._flush=e.flush))}_write(e,t){this._readableState.highWaterMark<=this._readableState.buffered?this._transformState.data=e:this._transform(e,this._transformState.afterTransform)}_read(e){var t;null!==this._transformState.data?(t=this._transformState.data,e(this._transformState.data=null),this._transform(t,this._transformState.afterTransform)):e(null)}destroy(e){super.destroy(e),null!==this._transformState.data&&(this._transformState.data=null,this._transformState.afterTransform())}_transform(e,t){t(null,e)}_flush(e){e(null)}_final(e){this._transformState.afterFinal=e,this._flush(transformAfterFlush.bind(this))}}class PassThrough extends Transform{}function transformAfterFlush(e,t){const n=this._transformState.afterFinal;if(e)return n(e);null!=t&&this.push(t),this.push(null),n(null)}function pipelinePromise(...e){return new Promise((t,n)=>pipeline(...e,e=>{if(e)return n(e);t()}))}function pipeline(e,...t){const n=Array.isArray(e)?[...e,...t]:[e,...t],r=n.length&&"function"==typeof n[n.length-1]?n.pop():null;if(n.length<2)throw new Error("Pipeline requires at least 2 streams");let s=n[0],i=null,o=null;for(let e=1;e<n.length;e++)i=n[e],isStreamx(s)?s.pipe(i,a):(function(e,t,n){e.on("error",n),e.on("close",function(){return e._readableState&&!e._readableState.ended||t&&e._writableState&&!e._writableState.ended?n(PREMATURE_CLOSE):void 0})}(s,1<e,a),s.pipe(i)),s=i;if(r){let e=!1;const d=isStreamx(i)||!(!i._writableState||!i._writableState.autoDestroy);i.on("error",e=>{null===o&&(o=e)}),i.on("finish",()=>{e=!0,d||r(o)}),d&&i.on("close",()=>r(o||(e?null:PREMATURE_CLOSE)))}return i;function a(e){if(e&&!o){o=e;for(const t of n)t.destroy(e)}}}function echo(e){return e}function isStream(e){return!!e._readableState||!!e._writableState}function isStreamx(e){return"number"==typeof e._duplexState&&isStream(e)}function isEnded(e){return!!e._readableState&&e._readableState.ended}function isFinished(e){return!!e._writableState&&e._writableState.ended}function getStreamError(e,t={}){e=e._readableState&&e._readableState.error||e._writableState&&e._writableState.error;return t.all||e!==STREAM_DESTROYED?e:null}function isReadStreamx(e){return isStreamx(e)&&e.readable}function isTypedArray(e){return"object"==typeof e&&null!==e&&"number"==typeof e.byteLength}function defaultByteLength(e){return isTypedArray(e)?e.byteLength:1024}function noop$1(){}function abort(){this.destroy(new Error("Stream aborted."))}function isWritev(e){return e._writev!==Writable.prototype._writev&&e._writev!==Duplex.prototype._writev}var streamx={pipeline:pipeline,pipelinePromise:pipelinePromise,isStream:isStream,isStreamx:isStreamx,isEnded:isEnded,isFinished:isFinished,getStreamError:getStreamError,Stream:Stream,Writable:Writable,Readable:Readable,Duplex:Duplex,Transform:Transform,PassThrough:PassThrough};function assign(e,t){for(const n in t)Object.defineProperty(e,n,{value:t[n],enumerable:!0,configurable:!0});return e}function createError(t,n,r){if(!t||"string"==typeof t)throw new TypeError("Please pass an Error to err-code");r=r||{},"object"==typeof n&&(r=n,n=""),n&&(r.code=n);try{return assign(t,r)}catch(e){r.message=t.message,r.stack=t.stack;function s(){}s.prototype=Object.create(Object.getPrototypeOf(t));n=assign(new s,r);return n}}var errCode=createError;const errCode$1=getDefaultExportFromCjs(createError),alphabet="0123456789abcdef",encodeLookup=[],decodeLookup=[];for(let e=0;e<256;e++)encodeLookup[e]=alphabet[e>>4&15]+alphabet[15&e],e<16&&(e<10?decodeLookup[48+e]=e:decodeLookup[87+e]=e);const arr2hex=e=>{var t=e.length;let n="",r=0;for(;r<t;)n+=encodeLookup[e[r++]];return n},hex2arr=e=>{var t=e.length>>1,n=t<<1;const r=new Uint8Array(t);let s=0,i=0;for(;i<n;)r[s++]=decodeLookup[e.charCodeAt(i++)]<<4|decodeLookup[e.charCodeAt(i++)];return r};for(var chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",lookup="undefined"==typeof Uint8Array?[]:new Uint8Array(256),i=0;i<chars.length;i++)lookup[chars.charCodeAt(i)]=i;const decoder=new TextDecoder,arr2text=(e,t)=>decoder.decode(e),encoder=new TextEncoder,text2arr=e=>encoder.encode(e),bin2hex=e=>{let t="";var n;let r=0;for(var s=e.length;r<s;)n=e.charCodeAt(r++),t+=alphabet[n>>4]+alphabet[15&n];return t},MAX_ARGUMENTS_LENGTH=65536,hex2bin=e=>{const t=hex2arr(e);if(t.length<=MAX_ARGUMENTS_LENGTH)return String.fromCharCode(...t);let n="",r=0;for(;r<t.length;)n+=String.fromCharCode(...t.subarray(r,r+=MAX_ARGUMENTS_LENGTH));return n},scope="undefined"!=typeof window?window:self,crypto=scope.crypto||scope.msCrypto||{},randomBytes=(crypto.subtle||crypto,e=>{e=new Uint8Array(e);return crypto.getRandomValues(e)}),Debug=debug$3("simple-peer"),MAX_BUFFERED_AMOUNT$1=65536,ICECOMPLETE_TIMEOUT=5e3,CHANNEL_CLOSING_TIMEOUT=5e3;function filterTrickle(e){return e.replace(/a=ice-options:trickle\s\n/g,"")}function warn(e){}let Peer$1=class $e extends streamx.Duplex{constructor(e){if(super(e=Object.assign({allowHalfOpen:!1},e)),__publicField(this,"_pc"),this.__objectMode=!!e.objectMode,this._id=arr2hex(randomBytes(4)).slice(0,7),this._debug("new peer %o",e),this.channelName=e.initiator?e.channelName||arr2hex(randomBytes(20)):null,this.initiator=e.initiator||!1,this.channelConfig=e.channelConfig||$e.channelConfig,this.channelNegotiated=this.channelConfig.negotiated,this.config=Object.assign({},$e.config,e.config),this.offerOptions=e.offerOptions||{},this.answerOptions=e.answerOptions||{},this.sdpTransform=e.sdpTransform||(e=>e),this.trickle=void 0===e.trickle||e.trickle,this.allowHalfTrickle=void 0!==e.allowHalfTrickle&&e.allowHalfTrickle,this.iceCompleteTimeout=e.iceCompleteTimeout||ICECOMPLETE_TIMEOUT,this._destroying=!1,this._connected=!1,this.remoteAddress=void 0,this.remoteFamily=void 0,this.remotePort=void 0,this.localAddress=void 0,this.localFamily=void 0,this.localPort=void 0,!RTCPeerConnection)throw"undefined"==typeof window?errCode$1(new Error("No WebRTC support: Specify `opts.wrtc` option in this environment"),"ERR_WEBRTC_SUPPORT"):errCode$1(new Error("No WebRTC support: Not a supported browser"),"ERR_WEBRTC_SUPPORT");this._pcReady=!1,this._channelReady=!1,this._iceComplete=!1,this._iceCompleteTimer=null,this._channel=null,this._pendingCandidates=[],this._isNegotiating=!1,this._firstNegotiation=!0,this._batchedNegotiation=!1,this._queuedNegotiation=!1,this._sendersAwaitingStable=[],this._closingInterval=null,this._remoteTracks=[],this._remoteStreams=[],this._chunk=null,this._cb=null,this._interval=null;try{this._pc=new RTCPeerConnection(this.config)}catch(e){return void this.__destroy(errCode$1(e,"ERR_PC_CONSTRUCTOR"))}this._isReactNativeWebrtc="number"==typeof this._pc._peerConnectionId,this._pc.oniceconnectionstatechange=()=>{this._onIceStateChange()},this._pc.onicegatheringstatechange=()=>{this._onIceStateChange()},this._pc.onconnectionstatechange=()=>{this._onConnectionStateChange()},this._pc.onsignalingstatechange=()=>{this._onSignalingStateChange()},this._pc.onicecandidate=e=>{this._onIceCandidate(e)},"object"==typeof this._pc.peerIdentity&&this._pc.peerIdentity.catch(e=>{this.__destroy(errCode$1(e,"ERR_PC_PEER_IDENTITY"))}),this.initiator||this.channelNegotiated?this._setupData({channel:this._pc.createDataChannel(this.channelName,this.channelConfig)}):this._pc.ondatachannel=e=>{this._setupData(e)},this._debug("initial negotiation"),this._needsNegotiation(),this._onFinishBound=()=>{this._onFinish()},this.once("finish",this._onFinishBound)}get bufferSize(){return this._channel&&this._channel.bufferedAmount||0}get connected(){return this._connected&&"open"===this._channel.readyState}address(){return{port:this.localPort,family:this.localFamily,address:this.localAddress}}signal(t){if(!this._destroying){if(this.destroyed)throw errCode$1(new Error("cannot signal after peer is destroyed"),"ERR_DESTROYED");if("string"==typeof t)try{t=JSON.parse(t)}catch(e){t={}}this._debug("signal()"),t.renegotiate&&this.initiator&&(this._debug("got request to renegotiate"),this._needsNegotiation()),t.transceiverRequest&&this.initiator&&(this._debug("got request for transceiver"),this.addTransceiver(t.transceiverRequest.kind,t.transceiverRequest.init)),t.candidate&&(this._pc.remoteDescription&&this._pc.remoteDescription.type?this._addIceCandidate(t.candidate):this._pendingCandidates.push(t.candidate)),t.sdp&&this._pc.setRemoteDescription(new RTCSessionDescription(t)).then(()=>{this.destroyed||(this._pendingCandidates.forEach(e=>{this._addIceCandidate(e)}),this._pendingCandidates=[],"offer"===this._pc.remoteDescription.type&&this._createAnswer())}).catch(e=>{this.__destroy(errCode$1(e,"ERR_SET_REMOTE_DESCRIPTION"))}),t.sdp||t.candidate||t.renegotiate||t.transceiverRequest||this.__destroy(errCode$1(new Error("signal() called with invalid signal data"),"ERR_SIGNALING"))}}_addIceCandidate(e){const t=new RTCIceCandidate(e);this._pc.addIceCandidate(t).catch(e=>{!t.address||t.address.endsWith(".local")?warn("Ignoring unsupported ICE candidate."):this.__destroy(errCode$1(e,"ERR_ADD_ICE_CANDIDATE"))})}send(e){if(!this._destroying){if(this.destroyed)throw errCode$1(new Error("cannot send after peer is destroyed"),"ERR_DESTROYED");this._channel.send(e)}}_needsNegotiation(){this._debug("_needsNegotiation"),this._batchedNegotiation||(this._batchedNegotiation=!0,queueMicrotask(()=>{this._batchedNegotiation=!1,this.initiator||!this._firstNegotiation?(this._debug("starting batched negotiation"),this.negotiate()):this._debug("non-initiator initial negotiation request discarded"),this._firstNegotiation=!1}))}negotiate(){if(!this._destroying){if(this.destroyed)throw errCode$1(new Error("cannot negotiate after peer is destroyed"),"ERR_DESTROYED");this.initiator?this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("start negotiation"),setTimeout(()=>{this._createOffer()},0)):this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("requesting negotiation from initiator"),this.emit("signal",{type:"renegotiate",renegotiate:!0})),this._isNegotiating=!0}}_final(e){this._readableState.ended||this.push(null),e(null)}__destroy(e){this.end(),this._destroy(()=>{},e)}_destroy(e,t){this.destroyed||this._destroying||(this._destroying=!0,this._debug("destroying (error: %s)",t&&(t.message||t)),setTimeout(()=>{if(this._connected=!1,this._pcReady=!1,this._channelReady=!1,this._remoteTracks=null,this._remoteStreams=null,this._senderMap=null,clearInterval(this._closingInterval),this._closingInterval=null,clearInterval(this._interval),this._interval=null,this._chunk=null,this._cb=null,this._onFinishBound&&this.removeListener("finish",this._onFinishBound),this._onFinishBound=null,this._channel){try{this._channel.close()}catch(e){}this._channel.onmessage=null,this._channel.onopen=null,this._channel.onclose=null,this._channel.onerror=null}if(this._pc){try{this._pc.close()}catch(e){}this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ontrack=null,this._pc.ondatachannel=null}this._pc=null,this._channel=null,t&&this.emit("error",t),e()},0))}_setupData(e){if(!e.channel)return this.__destroy(errCode$1(new Error("Data channel event is missing `channel` property"),"ERR_DATA_CHANNEL"));this._channel=e.channel,this._channel.binaryType="arraybuffer","number"==typeof this._channel.bufferedAmountLowThreshold&&(this._channel.bufferedAmountLowThreshold=MAX_BUFFERED_AMOUNT$1),this.channelName=this._channel.label,this._channel.onmessage=e=>{this._onChannelMessage(e)},this._channel.onbufferedamountlow=()=>{this._onChannelBufferedAmountLow()},this._channel.onopen=()=>{this._onChannelOpen()},this._channel.onclose=()=>{this._onChannelClose()};let t=!(this._channel.onerror=e=>{e=e.error instanceof Error?e.error:new Error(`Datachannel error: ${e.message} ${e.filename}:${e.lineno}:`+e.colno);this.__destroy(errCode$1(e,"ERR_DATA_CHANNEL"))});this._closingInterval=setInterval(()=>{t=!(!this._channel||"closing"!==this._channel.readyState)&&(t&&this._onChannelClose(),!0)},CHANNEL_CLOSING_TIMEOUT)}_write(e,t){if(this.destroyed)return t(errCode$1(new Error("cannot write after peer is destroyed"),"ERR_DATA_CHANNEL"));if(this._connected){try{this.send(e)}catch(e){return this.__destroy(errCode$1(e,"ERR_DATA_CHANNEL"))}this._channel.bufferedAmount>MAX_BUFFERED_AMOUNT$1?(this._debug("start backpressure: bufferedAmount %d",this._channel.bufferedAmount),this._cb=t):t(null)}else this._debug("write before connect"),this._chunk=e,this._cb=t}_onFinish(){var e;this.destroyed||(e=()=>{setTimeout(()=>this.__destroy(),1e3)},this._connected?e():this.once("connect",e))}_startIceCompleteTimeout(){this.destroyed||this._iceCompleteTimer||(this._debug("started iceComplete timeout"),this._iceCompleteTimer=setTimeout(()=>{this._iceComplete||(this._iceComplete=!0,this._debug("iceComplete timeout completed"),this.emit("iceTimeout"),this.emit("_iceComplete"))},this.iceCompleteTimeout))}_createOffer(){this.destroyed||this._pc.createOffer(this.offerOptions).then(t=>{if(!this.destroyed){this.trickle||this.allowHalfTrickle||(t.sdp=filterTrickle(t.sdp)),t.sdp=this.sdpTransform(t.sdp);const e=()=>{var e;this.destroyed||(e=this._pc.localDescription||t,this._debug("signal"),this.emit("signal",{type:e.type,sdp:e.sdp}))};this._pc.setLocalDescription(t).then(()=>{this._debug("createOffer success"),this.destroyed||(this.trickle||this._iceComplete?e():this.once("_iceComplete",e))}).catch(e=>{this.__destroy(errCode$1(e,"ERR_SET_LOCAL_DESCRIPTION"))})}}).catch(e=>{this.__destroy(errCode$1(e,"ERR_CREATE_OFFER"))})}_createAnswer(){this.destroyed||this._pc.createAnswer(this.answerOptions).then(t=>{if(!this.destroyed){this.trickle||this.allowHalfTrickle||(t.sdp=filterTrickle(t.sdp)),t.sdp=this.sdpTransform(t.sdp);const e=()=>{var e;this.destroyed||(e=this._pc.localDescription||t,this._debug("signal"),this.emit("signal",{type:e.type,sdp:e.sdp}),this.initiator||null!=(e=this._requestMissingTransceivers)&&e.call(this))};this._pc.setLocalDescription(t).then(()=>{this.destroyed||(this.trickle||this._iceComplete?e():this.once("_iceComplete",e))}).catch(e=>{this.__destroy(errCode$1(e,"ERR_SET_LOCAL_DESCRIPTION"))})}}).catch(e=>{this.__destroy(errCode$1(e,"ERR_CREATE_ANSWER"))})}_onConnectionStateChange(){this.destroyed||this._destroying||"failed"===this._pc.connectionState&&this.__destroy(errCode$1(new Error("Connection failed."),"ERR_CONNECTION_FAILURE"))}_onIceStateChange(){var e,t;this.destroyed||(this._debug("iceStateChange (connection: %s) (gathering: %s)",e=this._pc.iceConnectionState,t=this._pc.iceGatheringState),this.emit("iceStateChange",e,t),"connected"!==e&&"completed"!==e||(this._pcReady=!0,this._maybeReady()),"failed"===e&&this.__destroy(errCode$1(new Error("Ice connection failed."),"ERR_ICE_CONNECTION_FAILURE")),"closed"===e&&this.__destroy(errCode$1(new Error("Ice connection closed."),"ERR_ICE_CONNECTION_CLOSED")))}getStats(n){const s=t=>("[object Array]"===Object.prototype.toString.call(t.values)&&t.values.forEach(e=>{Object.assign(t,e)}),t);0===this._pc.getStats.length||this._isReactNativeWebrtc?this._pc.getStats().then(e=>{const t=[];e.forEach(e=>{t.push(s(e))}),n(null,t)},e=>n(e)):0<this._pc.getStats.length?this._pc.getStats(e=>{if(!this.destroyed){const r=[];e.result().forEach(t=>{const n={};t.names().forEach(e=>{n[e]=t.stat(e)}),n.id=t.id,n.type=t.type,n.timestamp=t.timestamp,r.push(s(n))}),n(null,r)}},e=>n(e)):n(null,[])}_maybeReady(){if(this._debug("maybeReady pc %s channel %s",this._pcReady,this._channelReady),!this._connected&&!this._connecting&&this._pcReady&&this._channelReady){this._connecting=!0;const d=()=>{this.destroyed||this._destroying||this.getStats((e,t)=>{if(!this.destroyed&&!this._destroying){const s={},i={},n={};let r=!1;(t=e?[]:t).forEach(e=>{"remotecandidate"!==e.type&&"remote-candidate"!==e.type||(s[e.id]=e),"localcandidate"!==e.type&&"local-candidate"!==e.type||(i[e.id]=e),"candidatepair"!==e.type&&"candidate-pair"!==e.type||(n[e.id]=e)});const o=e=>{r=!0;let t=i[e.localCandidateId],n=(t&&(t.ip||t.address)?(this.localAddress=t.ip||t.address,this.localPort=Number(t.port)):t&&t.ipAddress?(this.localAddress=t.ipAddress,this.localPort=Number(t.portNumber)):"string"==typeof e.googLocalAddress&&(t=e.googLocalAddress.split(":"),this.localAddress=t[0],this.localPort=Number(t[1])),this.localAddress&&(this.localFamily=this.localAddress.includes(":")?"IPv6":"IPv4"),s[e.remoteCandidateId]);n&&(n.ip||n.address)?(this.remoteAddress=n.ip||n.address,this.remotePort=Number(n.port)):n&&n.ipAddress?(this.remoteAddress=n.ipAddress,this.remotePort=Number(n.portNumber)):"string"==typeof e.googRemoteAddress&&(n=e.googRemoteAddress.split(":"),this.remoteAddress=n[0],this.remotePort=Number(n[1])),this.remoteAddress&&(this.remoteFamily=this.remoteAddress.includes(":")?"IPv6":"IPv4"),this._debug("connect local: %s:%s remote: %s:%s",this.localAddress,this.localPort,this.remoteAddress,this.remotePort)};if(t.forEach(e=>{"transport"===e.type&&e.selectedCandidatePairId&&o(n[e.selectedCandidatePairId]),("googCandidatePair"===e.type&&"true"===e.googActiveConnection||("candidatepair"===e.type||"candidate-pair"===e.type)&&e.selected)&&o(e)}),r||Object.keys(n).length&&!Object.keys(i).length){if(this._connecting=!1,this._connected=!0,this._chunk){try{this.send(this._chunk)}catch(e){return this.__destroy(errCode$1(e,"ERR_DATA_CHANNEL"))}this._chunk=null,this._debug('sent chunk from "write before connect"');const a=this._cb;this._cb=null,a(null)}"number"!=typeof this._channel.bufferedAmountLowThreshold&&(this._interval=setInterval(()=>this._onInterval(),150),this._interval.unref&&this._interval.unref()),this._debug("connect"),this.emit("connect")}else setTimeout(d,100)}})};d()}}_onInterval(){!this._cb||!this._channel||this._channel.bufferedAmount>MAX_BUFFERED_AMOUNT$1||this._onChannelBufferedAmountLow()}_onSignalingStateChange(){this.destroyed||("stable"===this._pc.signalingState&&(this._isNegotiating=!1,this._debug("flushing sender queue",this._sendersAwaitingStable),this._sendersAwaitingStable.forEach(e=>{this._pc.removeTrack(e),this._queuedNegotiation=!0}),this._sendersAwaitingStable=[],this._queuedNegotiation?(this._debug("flushing negotiation queue"),this._queuedNegotiation=!1,this._needsNegotiation()):(this._debug("negotiated"),this.emit("negotiated"))),this._debug("signalingStateChange %s",this._pc.signalingState),this.emit("signalingStateChange",this._pc.signalingState))}_onIceCandidate(e){this.destroyed||(e.candidate&&this.trickle?this.emit("signal",{type:"candidate",candidate:{candidate:e.candidate.candidate,sdpMLineIndex:e.candidate.sdpMLineIndex,sdpMid:e.candidate.sdpMid}}):e.candidate||this._iceComplete||(this._iceComplete=!0,this.emit("_iceComplete")),e.candidate&&this._startIceCompleteTimeout())}_onChannelMessage(t){if(!this.destroyed){let e=t.data;e instanceof ArrayBuffer?e=new Uint8Array(e):!1===this.__objectMode&&(e=text2arr(e)),this.push(e)}}_onChannelBufferedAmountLow(){if(!this.destroyed&&this._cb){this._debug("ending backpressure: bufferedAmount %d",this._channel.bufferedAmount);const e=this._cb;this._cb=null,e(null)}}_onChannelOpen(){this._connected||this.destroyed||(this._debug("on channel open"),this._channelReady=!0,this._maybeReady())}_onChannelClose(){this.destroyed||(this._debug("on channel close"),this.__destroy())}_debug(){const e=[].slice.call(arguments);e[0]="["+this._id+"] "+e[0],Debug.apply(null,e)}};Peer$1.WEBRTC_SUPPORT=!!RTCPeerConnection,Peer$1.config={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}],sdpSemantics:"unified-plan"},Peer$1.channelConfig={};const UDPTracker={},common$1=Object.freeze(Object.defineProperty({__proto__:null,default:UDPTracker},Symbol.toStringTag,{value:"Module"})),DEFAULT_ANNOUNCE_PEERS=50,MAX_ANNOUNCE_PEERS=82,parseUrl=e=>{const t=new URL(e.replace(/^udp:/,"http:"));return e.match(/^udp:/)&&Object.defineProperties(t,{href:{value:t.href.replace(/^http/,"udp")},protocol:{value:t.protocol.replace(/^http/,"udp")},origin:{value:t.origin.replace(/^http/,"udp")}}),t},common={DEFAULT_ANNOUNCE_PEERS:DEFAULT_ANNOUNCE_PEERS,MAX_ANNOUNCE_PEERS:MAX_ANNOUNCE_PEERS,parseUrl:parseUrl,...common$1},debug$2=debug$3("simple-websocket"),_WebSocket="function"!=typeof UDPTracker?WebSocket:UDPTracker,MAX_BUFFERED_AMOUNT=65536;class Socket extends streamx.Duplex{constructor(e={}){if("string"==typeof e&&(e={url:e}),super(e=Object.assign({allowHalfOpen:!1},e)),this.__objectMode=!!e.objectMode,null!=e.objectMode&&delete e.objectMode,null==e.url&&null==e.socket)throw new Error("Missing required `url` or `socket` option");if(null!=e.url&&null!=e.socket)throw new Error("Must specify either `url` or `socket` option, not both");if(this._id=arr2hex(randomBytes(4)).slice(0,7),this._debug("new websocket: %o",e),this.connected=!1,this._chunk=null,this._cb=null,this._interval=null,e.socket)this.url=e.socket.url,this._ws=e.socket,this.connected=e.socket.readyState===_WebSocket.OPEN;else{this.url=e.url;try{"function"==typeof UDPTracker?this._ws=new _WebSocket(e.url,{...e,encoding:void 0}):this._ws=new _WebSocket(e.url)}catch(e){return void queueMicrotask$2(()=>this.destroy(e))}}this._ws.binaryType="arraybuffer",e.socket&&this.connected?queueMicrotask$2(()=>this._handleOpen()):this._ws.onopen=()=>this._handleOpen(),this._ws.onmessage=e=>this._handleMessage(e),this._ws.onclose=()=>this._handleClose(),this._ws.onerror=e=>this._handleError(e),this._handleFinishBound=()=>this._handleFinish(),this.once("finish",this._handleFinishBound)}send(e){this._ws.send(e)}_final(e){this._readableState.ended||this.push(null),e(null)}_destroy(e){if(!this.destroyed){if(this._writableState.ended||this.end(),this.connected=!1,clearInterval(this._interval),this._interval=null,this._chunk=null,this._cb=null,this._handleFinishBound&&this.removeListener("finish",this._handleFinishBound),this._handleFinishBound=null,this._ws){const n=this._ws;var t=()=>{n.onclose=null};if(n.readyState===_WebSocket.CLOSED)t();else try{n.onclose=t,n.close()}catch(e){t()}n.onopen=null,n.onmessage=null,n.onerror=()=>{}}this._ws=null,e()}}_write(e,t){if(this.destroyed)return t(new Error("cannot write after socket is destroyed"));if(this.connected){try{this.send(e)}catch(e){return this.destroy(e)}"function"!=typeof UDPTracker&&this._ws.bufferedAmount>MAX_BUFFERED_AMOUNT?(this._debug("start backpressure: bufferedAmount %d",this._ws.bufferedAmount),this._cb=t):t(null)}else this._debug("write before connect"),this._chunk=e,this._cb=t}_handleOpen(){if(!this.connected&&!this.destroyed){if(this.connected=!0,this._chunk){try{this.send(this._chunk)}catch(e){return this.destroy(e)}this._chunk=null,this._debug('sent chunk from "write before connect"');const e=this._cb;this._cb=null,e(null)}"function"!=typeof UDPTracker&&(this._interval=setInterval(()=>this._onInterval(),150),this._interval.unref&&this._interval.unref()),this._debug("connect"),this.emit("connect")}}_handleMessage(t){if(!this.destroyed){let e=t.data;e instanceof ArrayBuffer&&(e=new Uint8Array(e)),!1===this.__objectMode&&(e=text2arr(e)),this.push(e)}}_handleClose(){this.destroyed||(this._debug("on close"),this.destroy())}_handleError(e){this.destroy(new Error("Error connecting to "+this.url))}_handleFinish(){var e;this.destroyed||(e=()=>{setTimeout(()=>this.destroy(),1e3)},this.connected?e():this.once("connect",e))}_onInterval(){if(this._cb&&this._ws&&!(this._ws.bufferedAmount>MAX_BUFFERED_AMOUNT)){this._debug("ending backpressure: bufferedAmount %d",this._ws.bufferedAmount);const e=this._cb;this._cb=null,e(null)}}_debug(){const e=[].slice.call(arguments);e[0]="["+this._id+"] "+e[0],debug$2.apply(null,e)}}Socket.WEBSOCKET_SUPPORT=!!_WebSocket;class Tracker extends EventEmitter$2{constructor(e,t){super(),this.client=e,this.announceUrl=t,this.interval=null,this.destroyed=!1}setInterval(e){null==e&&(e=this.DEFAULT_ANNOUNCE_INTERVAL),clearInterval(this.interval),e&&(this.interval=setInterval(()=>{this.announce(this.client._defaultAnnounceOpts())},e),this.interval.unref&&this.interval.unref())}}const debug$1=debug$3("bittorrent-tracker:websocket-tracker"),socketPool={},RECONNECT_MINIMUM=1e4,RECONNECT_MAXIMUM=36e5,RECONNECT_VARIANCE=3e5,OFFER_TIMEOUT=5e4;class WebSocketTracker extends Tracker{constructor(e,t){super(e,t),debug$1("new websocket tracker %s",t),this.peers={},this.socket=null,this.reconnecting=!1,this.retries=0,this.reconnectTimer=null,this.expectingResponse=!1,this._openSocket()}announce(e){if(!this.destroyed&&!this.reconnecting)if(this.socket.connected){const t=Object.assign({},e,{action:"announce",info_hash:this.client._infoHashBinary,peer_id:this.client._peerIdBinary});if(this._trackerId&&(t.trackerid=this._trackerId),"stopped"===e.event||"completed"===e.event)this._send(t);else{const n=Math.min(e.numwant,5);this._generateOffers(n,e=>{t.numwant=n,t.offers=e,this._send(t)})}}else this.socket.once("connect",()=>{this.announce(e)})}scrape(e){var t;this.destroyed||this.reconnecting||(this.socket.connected?(t=Array.isArray(e.infoHash)&&0<e.infoHash.length?e.infoHash.map(e=>hex2bin(e)):e.infoHash&&hex2bin(e.infoHash)||this.client._infoHashBinary,this._send({action:"scrape",info_hash:t})):this.socket.once("connect",()=>{this.scrape(e)}))}destroy(e=noop){if(this.destroyed)return e(null);this.destroyed=!0,clearInterval(this.interval),clearTimeout(this.reconnectTimer);for(const s in this.peers){const i=this.peers[s];clearTimeout(i.trackerTimeout),i.destroy()}if(this.peers=null,this.socket&&(this.socket.removeListener("connect",this._onSocketConnectBound),this.socket.removeListener("data",this._onSocketDataBound),this.socket.removeListener("close",this._onSocketCloseBound),this.socket.removeListener("error",this._onSocketErrorBound),this.socket=null),this._onSocketConnectBound=null,this._onSocketErrorBound=null,this._onSocketDataBound=null,this._onSocketCloseBound=null,socketPool[this.announceUrl]&&--socketPool[this.announceUrl].consumers,0<socketPool[this.announceUrl].consumers)return e();let t=socketPool[this.announceUrl];delete socketPool[this.announceUrl],t.on("error",noop),t.once("close",e);let n;if(!this.expectingResponse)return r();function r(){n&&(clearTimeout(n),n=null),t.removeListener("data",r),t.destroy(),t=null}n=setTimeout(r,common.DESTROY_TIMEOUT),t.once("data",r)}_openSocket(){if(this.destroyed=!1,this.peers||(this.peers={}),this._onSocketConnectBound=()=>{this._onSocketConnect()},this._onSocketErrorBound=e=>{this._onSocketError(e)},this._onSocketDataBound=e=>{this._onSocketData(e)},this._onSocketCloseBound=()=>{this._onSocketClose()},this.socket=socketPool[this.announceUrl],this.socket)socketPool[this.announceUrl].consumers+=1,this.socket.connected&&this._onSocketConnectBound();else{var t=new URL(this.announceUrl);let e;this.client._proxyOpts&&!(e="wss:"===t.protocol?this.client._proxyOpts.httpsAgent:this.client._proxyOpts.httpAgent)&&this.client._proxyOpts.socksProxy&&(e=this.client._proxyOpts.socksProxy),this.socket=socketPool[this.announceUrl]=new Socket({url:this.announceUrl,agent:e}),this.socket.consumers=1,this.socket.once("connect",this._onSocketConnectBound)}this.socket.on("data",this._onSocketDataBound),this.socket.once("close",this._onSocketCloseBound),this.socket.once("error",this._onSocketErrorBound)}_onSocketConnect(){this.destroyed||this.reconnecting&&(this.reconnecting=!1,this.retries=0,this.announce(this.client._defaultAnnounceOpts()))}_onSocketData(e){if(!this.destroyed){this.expectingResponse=!1;try{e=JSON.parse(arr2text(e))}catch(e){return void this.client.emit("warning",new Error("Invalid tracker response"))}"announce"===e.action?this._onAnnounceResponse(e):"scrape"===e.action?this._onScrapeResponse(e):this._onSocketError(new Error("invalid action in WS response: "+e.action))}}_onAnnounceResponse(n){if(n.info_hash!==this.client._infoHashBinary)debug$1("ignoring websocket data from %s for %s (looking for %s: reused socket)",this.announceUrl,bin2hex(n.info_hash),this.client.infoHash);else if(!n.peer_id||n.peer_id!==this.client._peerIdBinary){debug$1("received %s from %s for %s",JSON.stringify(n),this.announceUrl,this.client.infoHash);var t=n["failure reason"];if(t)return this.client.emit("warning",new Error(t));var t=n["warning message"],t=(t&&this.client.emit("warning",new Error(t)),n.interval||n["min interval"]),t=(t&&this.setInterval(1e3*t),n["tracker id"]);t&&(this._trackerId=t),null!=n.complete&&(t=Object.assign({},n,{announce:this.announceUrl,infoHash:bin2hex(n.info_hash)}),this.client.emit("update",t));let e;n.offer&&n.peer_id&&(debug$1("creating peer (from remote offer)"),(e=this._createPeer()).id=bin2hex(n.peer_id),e.once("signal",e=>{const t={action:"announce",info_hash:this.client._infoHashBinary,peer_id:this.client._peerIdBinary,to_peer_id:n.peer_id,answer:e,offer_id:n.offer_id};this._trackerId&&(t.trackerid=this._trackerId),this._send(t)}),this.client.emit("peer",e),e.signal(n.offer)),n.answer&&n.peer_id&&(t=bin2hex(n.offer_id),(e=this.peers[t])?(e.id=bin2hex(n.peer_id),this.client.emit("peer",e),e.signal(n.answer),clearTimeout(e.trackerTimeout),e.trackerTimeout=null,delete this.peers[t]):debug$1("got unexpected answer: "+JSON.stringify(n.answer)))}}_onScrapeResponse(t){t=t.files||{};const e=Object.keys(t);0===e.length?this.client.emit("warning",new Error("invalid scrape response")):e.forEach(e=>{e=Object.assign(t[e],{announce:this.announceUrl,infoHash:bin2hex(e)});this.client.emit("scrape",e)})}_onSocketClose(){this.destroyed||(this.destroy(),this._startReconnectTimer())}_onSocketError(e){this.destroyed||(this.destroy(),this.client.emit("warning",e),this._startReconnectTimer())}_startReconnectTimer(){var e=Math.floor(Math.random()*RECONNECT_VARIANCE)+Math.min(Math.pow(2,this.retries)*RECONNECT_MINIMUM,RECONNECT_MAXIMUM);this.reconnecting=!0,clearTimeout(this.reconnectTimer),this.reconnectTimer=setTimeout(()=>{this.retries++,this._openSocket()},e),this.reconnectTimer.unref&&this.reconnectTimer.unref(),debug$1("reconnecting socket in %s ms",e)}_send(e){this.destroyed||(this.expectingResponse=!0,e=JSON.stringify(e),debug$1("send %s",e),this.socket.send(e))}_generateOffers(t,e){const n=this,r=[];debug$1("generating %s offers",t);for(let e=0;e<t;++e)!function(){const t=arr2hex(randomBytes(20)),e=(debug$1("creating peer (from _generateOffers)"),n.peers[t]=n._createPeer({initiator:!0}));e.once("signal",e=>{r.push({offer:e,offer_id:hex2bin(t)}),s()}),e.trackerTimeout=setTimeout(()=>{debug$1("tracker timeout: destroying peer"),e.trackerTimeout=null,delete n.peers[t],e.destroy()},OFFER_TIMEOUT),e.trackerTimeout.unref&&e.trackerTimeout.unref()}();function s(){r.length===t&&(debug$1("generated %s offers",t),e(r))}s()}_createPeer(e){const t=this,n=(e=Object.assign({trickle:!1,config:t.client._rtcConfig,wrtc:t.client._wrtc},e),new Peer$1(e));return n.once("error",r),n.once("connect",function e(){n.removeListener("error",r);n.removeListener("connect",e)}),n;function r(e){t.client.emit("warning",new Error("Connection error: "+e.message)),n.destroy()}}}function noop(){}WebSocketTracker.prototype.DEFAULT_ANNOUNCE_INTERVAL=3e4,WebSocketTracker._socketPool=socketPool;const debug=debug$3("bittorrent-tracker:client");class Client extends EventEmitter$2{constructor(e={}){if(super(),!e.peerId)throw new Error("Option `peerId` is required");if(!e.infoHash)throw new Error("Option `infoHash` is required");if(!e.announce)throw new Error("Option `announce` is required");if(!process$1.browser&&!e.port)throw new Error("Option `port` is required");this.peerId="string"==typeof e.peerId?e.peerId:arr2hex(e.peerId),this._peerIdBuffer=hex2arr(this.peerId),this._peerIdBinary=hex2bin(this.peerId),this.infoHash="string"==typeof e.infoHash?e.infoHash.toLowerCase():arr2hex(e.infoHash),this._infoHashBuffer=hex2arr(this.infoHash),this._infoHashBinary=hex2bin(this.infoHash),debug("new client %s",this.infoHash),this.destroyed=!1,this._port=e.port,this._getAnnounceOpts=e.getAnnounceOpts,this._rtcConfig=e.rtcConfig,this._userAgent=e.userAgent,this._proxyOpts=e.proxyOpts,this._wrtc="function"==typeof e.wrtc?e.wrtc():e.wrtc;let t="string"==typeof e.announce?[e.announce]:null==e.announce?[]:e.announce;t=t.map(e=>e="/"===(e=ArrayBuffer.isView(e)?arr2text(e):e)[e.length-1]?e.substring(0,e.length-1):e),t=Array.from(new Set(t));const r=!1!==this._wrtc&&(!!this._wrtc||Peer$1.WEBRTC_SUPPORT),s=e=>{queueMicrotask$2(()=>{this.emit("warning",e)})};this._trackers=t.map(t=>{let e;try{e=common.parseUrl(t)}catch(e){return s(new Error("Invalid tracker URL: "+t)),null}var n=e.port;if(n<0||65535<n)return s(new Error("Invalid tracker port: "+t)),null;n=e.protocol;return("http:"===n||"https:"===n)&&"function"==typeof UDPTracker||"udp:"===n&&"function"==typeof UDPTracker?new UDPTracker(this,t):"ws:"!==n&&"wss:"!==n||!r||"ws:"===n&&"undefined"!=typeof window&&"https:"===window.location.protocol?(s(new Error("Unsupported tracker protocol: "+t)),null):new WebSocketTracker(this,t)}).filter(Boolean)}start(e){(e=this._defaultAnnounceOpts(e)).event="started",debug("send `start` %o",e),this._announce(e),this._trackers.forEach(e=>{e.setInterval()})}stop(e){(e=this._defaultAnnounceOpts(e)).event="stopped",debug("send `stop` %o",e),this._announce(e)}complete(e){(e=this._defaultAnnounceOpts(e=e||{})).event="completed",debug("send `complete` %o",e),this._announce(e)}update(e){(e=this._defaultAnnounceOpts(e)).event&&delete e.event,debug("send `update` %o",e),this._announce(e)}_announce(t){this._trackers.forEach(e=>{e.announce(t)})}scrape(t){debug("send `scrape`"),t=t||{},this._trackers.forEach(e=>{e.scrape(t)})}setInterval(t){debug("setInterval %d",t),this._trackers.forEach(e=>{e.setInterval(t)})}destroy(e){var t;this.destroyed||(this.destroyed=!0,debug("destroy"),t=this._trackers.map(t=>e=>{t.destroy(e)}),parallel(t,e),this._trackers=[],this._getAnnounceOpts=null)}_defaultAnnounceOpts(e={}){return null==e.numwant&&(e.numwant=common.DEFAULT_ANNOUNCE_PEERS),null==e.uploaded&&(e.uploaded=0),null==e.downloaded&&(e.downloaded=0),e=this._getAnnounceOpts?Object.assign({},e,this._getAnnounceOpts()):e}}Client.scrape=(e,t)=>{if(t=once$1(t),!e.infoHash)throw new Error("Option `infoHash` is required");if(!e.announce)throw new Error("Option `announce` is required");var n=Object.assign({},e,{infoHash:Array.isArray(e.infoHash)?e.infoHash[0]:e.infoHash,peerId:text2arr("01234567890123456789"),port:6881});const r=new Client(n);r.once("error",t),r.once("warning",t);let s=Array.isArray(e.infoHash)?e.infoHash.length:1;const i={};return r.on("scrape",e=>{--s,i[e.infoHash]=e,0===s&&(r.destroy(),e=Object.keys(i),t(null,1===e.length?i[e[0]]:i))}),r.scrape({infoHash:e.infoHash}),r};var md5$1={exports:{}};function FF(e,t,n,r,s,i,o){e=e+(t&n|~t&r)+(s>>>0)+o;return(e<<i|e>>>32-i)+t}function GG(e,t,n,r,s,i,o){e=e+(t&r|n&~r)+(s>>>0)+o;return(e<<i|e>>>32-i)+t}function HH(e,t,n,r,s,i,o){e=e+(t^n^r)+(s>>>0)+o;return(e<<i|e>>>32-i)+t}function II(e,t,n,r,s,i,o){e=e+(n^(t|~r))+(s>>>0)+o;return(e<<i|e>>>32-i)+t}function byteToHex(e){return(256+(255&e)).toString(16).substr(-2)}function bs(e){return String.fromCharCode(255&e)}function wordToBytes(e){return bs(e)+bs(e>>>8)+bs(e>>>16)+bs(e>>>24)}var utf8toBytes=function(e){return unescape(encodeURIComponent(e))};function bytesToWords(e){for(var t=e.length,n=t<<3,r=new Uint32Array(t+72>>>6<<4),s=0,i=e.length;s<i;++s)r[s>>>2]|=e.charCodeAt(s)<<((3&s)<<3);return r[t>>2]|=128<<(31&n),r[r.length-2]=n,r}var exports=md5$1.exports=function(e){return utf8toMD5(e).toHex()},bytesToMD5=exports.fromBytes=function(e){for(var t=bytesToWords(e),n=1732584193,r=4023233417,s=2562383102,i=271733878,o=0,a=t.length;o<a;o+=16){var d=n,h=r,l=s,c=i,n=FF(n,r,s,i,t[o+0],7,3614090360),i=FF(i,n,r,s,t[o+1],12,3905402710),s=FF(s,i,n,r,t[o+2],17,606105819),r=FF(r,s,i,n,t[o+3],22,3250441966);n=FF(n,r,s,i,t[o+4],7,4118548399),i=FF(i,n,r,s,t[o+5],12,1200080426),s=FF(s,i,n,r,t[o+6],17,2821735955),r=FF(r,s,i,n,t[o+7],22,4249261313),n=FF(n,r,s,i,t[o+8],7,1770035416),i=FF(i,n,r,s,t[o+9],12,2336552879),s=FF(s,i,n,r,t[o+10],17,4294925233),r=FF(r,s,i,n,t[o+11],22,2304563134),n=FF(n,r,s,i,t[o+12],7,1804603682),i=FF(i,n,r,s,t[o+13],12,4254626195),s=FF(s,i,n,r,t[o+14],17,2792965006),n=GG(n,r=FF(r,s,i,n,t[o+15],22,1236535329),s,i,t[o+1],5,4129170786),i=GG(i,n,r,s,t[o+6],9,3225465664),s=GG(s,i,n,r,t[o+11],14,643717713),r=GG(r,s,i,n,t[o+0],20,3921069994),n=GG(n,r,s,i,t[o+5],5,3593408605),i=GG(i,n,r,s,t[o+10],9,38016083),s=GG(s,i,n,r,t[o+15],14,3634488961),r=GG(r,s,i,n,t[o+4],20,3889429448),n=GG(n,r,s,i,t[o+9],5,568446438),i=GG(i,n,r,s,t[o+14],9,3275163606),s=GG(s,i,n,r,t[o+3],14,4107603335),r=GG(r,s,i,n,t[o+8],20,1163531501),n=GG(n,r,s,i,t[o+13],5,2850285829),i=GG(i,n,r,s,t[o+2],9,4243563512),s=GG(s,i,n,r,t[o+7],14,1735328473),n=HH(n,r=GG(r,s,i,n,t[o+12],20,2368359562),s,i,t[o+5],4,4294588738),i=HH(i,n,r,s,t[o+8],11,2272392833),s=HH(s,i,n,r,t[o+11],16,1839030562),r=HH(r,s,i,n,t[o+14],23,4259657740),n=HH(n,r,s,i,t[o+1],4,2763975236),i=HH(i,n,r,s,t[o+4],11,1272893353),s=HH(s,i,n,r,t[o+7],16,4139469664),r=HH(r,s,i,n,t[o+10],23,3200236656),n=HH(n,r,s,i,t[o+13],4,681279174),i=HH(i,n,r,s,t[o+0],11,3936430074),s=HH(s,i,n,r,t[o+3],16,3572445317),r=HH(r,s,i,n,t[o+6],23,76029189),n=HH(n,r,s,i,t[o+9],4,3654602809),i=HH(i,n,r,s,t[o+12],11,3873151461),s=HH(s,i,n,r,t[o+15],16,530742520),n=II(n,r=HH(r,s,i,n,t[o+2],23,3299628645),s,i,t[o+0],6,4096336452),i=II(i,n,r,s,t[o+7],10,1126891415),s=II(s,i,n,r,t[o+14],15,2878612391),r=II(r,s,i,n,t[o+5],21,4237533241),n=II(n,r,s,i,t[o+12],6,1700485571),i=II(i,n,r,s,t[o+3],10,2399980690),s=II(s,i,n,r,t[o+10],15,4293915773),r=II(r,s,i,n,t[o+1],21,2240044497),n=II(n,r,s,i,t[o+8],6,1873313359),i=II(i,n,r,s,t[o+15],10,4264355552),s=II(s,i,n,r,t[o+6],15,2734768916),r=II(r,s,i,n,t[o+13],21,1309151649),n=II(n,r,s,i,t[o+4],6,4149444226),i=II(i,n,r,s,t[o+11],10,3174756917),s=II(s,i,n,r,t[o+2],15,718787259),r=II(r,s,i,n,t[o+9],21,3951481745),n=n+d>>>0,r=r+h>>>0,s=s+l>>>0,i=i+c>>>0}var u=new String(wordToBytes(n)+wordToBytes(r)+wordToBytes(s)+wordToBytes(i));return u.toHex=function(){for(var e="",t=0,n=u.length;t<n;++t)e+=byteToHex(u.charCodeAt(t));return e},u},utf8toMD5=exports.fromUtf8=function(e){return bytesToMD5(utf8toBytes(e))},b64="./0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";function to64(e,t){for(var n="";0<=--t;e>>>=6)n+=b64.charAt(63&e);return n}var MAX_KEY_LENGTH=64,b64_map=[0,6,12,1,7,13,2,8,14,3,9,15,4,10,5,11],gen_salt=exports.salt=function(e){var t="";for(e=e||8;t+=b64.charAt(64*Math.random()>>>0),--e;);return t},md5Exports=(exports.crypt=function(e,t){if(MAX_KEY_LENGTH<e.length)throw Error("too long key");t=t||"$1$"+gen_salt(),e=utf8toBytes(e);for(var n=utf8toBytes(t.replace(/^\$1\$([^$]+)(?:\$.*)?$/,"$1")),r=bytesToMD5(e+n+e),s=e+"$1$"+n,i=e.length;16<i;i-=16)s+=r;s+=r.slice(0,i);for(i=e.length;i;i>>=1)s+=1&i?"\0":e.charAt(0);for(var r=bytesToMD5(s),o=0;o<1e3;++o)r=bytesToMD5((1&o?e:r)+(o%3?n:"")+(o%7?e:"")+(1&o?r:e));for(var a="$1$"+n+"$",o=0;o<15;o+=3)a+=to64(r.charCodeAt(b64_map[o+0])<<16|r.charCodeAt(b64_map[o+1])<<8|r.charCodeAt(b64_map[o+2]),4);return a+to64(r.charCodeAt(b64_map[15]),2)},md5$1.exports);const md52=getDefaultExportFromCjs(md5Exports),PACKAGE_VERSION="2.0.1",TRACKER_CLIENT_VERSION_PREFIX=`-PM${formatVersion(PACKAGE_VERSION)}-`,HASH_SYMBOLS="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",PEER_ID_LENGTH=20;function getStreamHash(e){e=md52.fromUtf8(e).slice(1);return btoa(e)}function generatePeerId(e){const t=[e];var n=PEER_ID_LENGTH-e.length;for(let e=0;e<n;e++)t.push(HASH_SYMBOLS[Math.floor(Math.random()*HASH_SYMBOLS.length)]);return t.join("")}function formatVersion(e){const t=e.split(".");return""+t[0].padStart(2,"0")+t[1].padStart(2,"0")}function getStreamString(e){return e.type+"-"+e.index}function getSegmentString(e){var t=e["externalId"];return`(${getStreamString(e.stream)} | ${t})`}function getControlledPromise(){let n,r;return{promise:new Promise((e,t)=>{n=e,r=t}),resolve:n,reject:r}}function joinChunks(e,t){void 0===t&&(t=e.reduce((e,t)=>e+t.byteLength,0));const n=new Uint8Array(t);let r=0;for(const s of e)n.set(s,r),r+=s.byteLength;return n}function getRandomItem(e){return e[Math.floor(Math.random()*e.length)]}function utf8ToUintArray(e){const t=new TextEncoder;var n=new Uint8Array(e.length);return t.encodeInto(e,n),n}function hexToUtf8(t){const n=new Uint8Array(t.length/2);for(let e=0;e<t.length;e+=2)n[e/2]=parseInt(t.slice(e,e+2),16);const e=new TextDecoder;return e.decode(n)}function*arrayBackwards(t){for(let e=t.length-1;0<=e;e--)yield t[e]}function isObject(e){return!!e&&"object"==typeof e&&!Array.isArray(e)}function isArray(e){return Array.isArray(e)}function filterUndefinedProps(e){return function n(r){if(isObject(r)){const s={};return Object.keys(r).forEach(e=>{var t;void 0!==r[e]&&void 0!==(t=n(r[e]))&&(s[e]=t)}),s}return r}(e)}function deepCopy(e){if(isArray(e))return e.map(e=>deepCopy(e));if(isObject(e)){const t={};for(const n of Object.keys(e))t[n]=deepCopy(e[n]);return t}return e}function shuffleArray(t){for(let e=t.length-1;0<e;e--){var n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}return t}function overrideConfig(r,s,i={}){return"object"!=typeof r||null===r||"object"!=typeof s||null===s||Object.keys(s).forEach(e=>{if("__proto__"===e||"constructor"===e||"prototype"===e)throw new Error(`Attempt to modify restricted property '${String(e)}'`);var t=s[e],n=i[e];e in r&&(r[e]=void 0===t?void 0===n?void 0:n:t)}),r}function mergeAndFilterConfig(e){var{defaultConfig:e,baseConfig:t={},specificStreamConfig:n={}}=e;const r=deepCopy({...e,...t,...n}),s=Object.keys(e),i={};return s.forEach(e=>{e in r&&(i[e]=r[e])}),i}var PeerCommandType$1=(e=>(e[e.SegmentsAnnouncement=0]="SegmentsAnnouncement",e[e.SegmentRequest=1]="SegmentRequest",e[e.SegmentData=2]="SegmentData",e[e.SegmentDataSendingCompleted=3]="SegmentDataSendingCompleted",e[e.SegmentAbsent=4]="SegmentAbsent",e[e.CancelSegmentRequest=5]="CancelSegmentRequest",e))(PeerCommandType$1||{}),SerializedItem=(e=>(e[e.Min=-1]="Min",e[e.Int=0]="Int",e[e.SimilarIntArray=1]="SimilarIntArray",e[e.String=2]="String",e[e.Max=3]="Max",e))(SerializedItem||{});function abs(e){return e<0?-e:e}function getRequiredBytesForInt(e){var t=e.toString(2);return Math.ceil((e<0?t.length:t.length+1)/8)}function intToBytes(t){var e=t<0,n=getRequiredBytesForInt(t);const r=new Uint8Array(n);var s=BigInt(n);t=abs(t);for(let e=0;e<n;e++){var i=8n*(s-1n-BigInt(e));r[e]=Number(t>>i&0xffn)}return e&&(r[0]=128|r[0]),r}function bytesToInt(t){const n=BigInt(t.length);var r=(e,t)=>{t=8n*(n-1n-BigInt(t));return BigInt(e)<<t};let s=r(127&t[0],0);for(let e=1;e<n;e++)s=r(t[e],e)|s;return s=(128&t[0])>>7!=0?-s:s}function serializeInt(e){e=intToBytes(e);return new Uint8Array([0|e.length,...e])}function deserializeInt(e){var t=e[0];if(0!=t>>4)throw new Error("Trying to deserialize integer with invalid serialized item code");t&=15;return{number:bytesToInt(e.slice(1,1+t)),byteLength:1+t}}function serializeSimilarIntArray(e){const t=new Map;for(const d of e){var n=~0xffn&d,r=0xffn&d;const h=t.get(n)??new ResizableUint8Array;h.length||t.set(n,h),h.push(Number(r))}const s=new ResizableUint8Array;s.push([16,t.size]);for(var[i,o]of t){var a=o.getBytesChunks()["length"],i=i|0xffn&BigInt(a);o.unshift(serializeInt(i)),s.push(o.getBuffer())}return s.getBuffer()}function deserializeSimilarIntArray(t){var[e,n]=t;if(1!=e>>4)throw new Error("Trying to deserialize similar int array with invalid serialized item code");let r=2;const s=[];for(let e=0;e<n;e++){var{number:i,byteLength:o}=deserializeInt(t.slice(r)),a=(r+=o,0xffn&i),d=~0xffn&i;for(let e=0;e<a;e++){var h=BigInt(t[r]);s.push(d|h),r++}}return{numbers:s,byteLength:r}}function serializeString(e){var t=e["length"];const n=new ResizableUint8Array;return n.push([32|t>>8&15,255&t]),n.push((new TextEncoder).encode(e)),n.getBuffer()}function deserializeString(e){var[t,n]=e;if(2!=t>>4)throw new Error("Trying to deserialize bytes (sting) with invalid serialized item code.");t=(15&t)<<8|n,n=e.slice(2,2+t);return{string:new TextDecoder("utf8").decode(n),byteLength:2+t}}class ResizableUint8Array{constructor(){__publicField(this,"bytes",[]),__publicField(this,"_length",0)}push(e){this.addBytes(e,"end")}unshift(e){this.addBytes(e,"start")}addBytes(e,t){let n;n=e instanceof Uint8Array?e:Array.isArray(e)?new Uint8Array(e):new Uint8Array([e]),this._length+=n.length,this.bytes["start"===t?"unshift":"push"](n)}getBytesChunks(){return this.bytes}getBuffer(){return joinChunks(this.bytes,this._length)}get length(){return this._length}}const FRAME_PART_LENGTH=4,commandFrameStart=stringToUtf8CodesBuffer("cstr",FRAME_PART_LENGTH),commandFrameEnd=stringToUtf8CodesBuffer("cend",FRAME_PART_LENGTH),commandDivFrameStart=stringToUtf8CodesBuffer("dstr",FRAME_PART_LENGTH),commandDivFrameEnd=stringToUtf8CodesBuffer("dend",FRAME_PART_LENGTH),startFrames=[commandFrameStart,commandDivFrameStart],endFrames=[commandFrameEnd,commandDivFrameEnd],commandFramesLength=commandFrameStart.length+commandFrameEnd.length;function isCommandChunk(t){var e=commandFrameStart.length;const n=t.slice(-e);return startFrames.some(e=>areBuffersEqual(t,e,FRAME_PART_LENGTH))&&endFrames.some(e=>areBuffersEqual(n,e,FRAME_PART_LENGTH))}function isFirstCommandChunk(e){return areBuffersEqual(e,commandFrameStart,FRAME_PART_LENGTH)}function isLastCommandChunk(e){return areBuffersEqual(e.slice(-FRAME_PART_LENGTH),commandFrameEnd,FRAME_PART_LENGTH)}class BinaryCommandJoiningError extends Error{constructor(e){super(),this.type=e}}class BinaryCommandChunksJoiner{constructor(e){__publicField(this,"chunks",new ResizableUint8Array),__publicField(this,"status","joining"),this.onComplete=e}addCommandChunk(e){if("completed"!==this.status){var t=isFirstCommandChunk(e);if(!this.chunks.length&&!t)throw new BinaryCommandJoiningError("no-first-chunk");if(this.chunks.length&&t)throw new BinaryCommandJoiningError("incomplete-joining");this.chunks.push(this.unframeCommandChunk(e)),isLastCommandChunk(e)&&(this.status="completed",this.onComplete(this.chunks.getBuffer()))}}unframeCommandChunk(e){return e.slice(FRAME_PART_LENGTH,e.length-FRAME_PART_LENGTH)}}class BinaryCommandCreator{constructor(e,t){__publicField(this,"bytes",new ResizableUint8Array),__publicField(this,"resultBuffers",[]),__publicField(this,"status","creating"),this.maxChunkLength=t,this.bytes.push(e)}addInteger(e,t){this.bytes.push(e.charCodeAt(0));e=serializeInt(BigInt(t));this.bytes.push(e)}addSimilarIntArr(e,t){this.bytes.push(e.charCodeAt(0));e=serializeSimilarIntArray(t.map(e=>BigInt(e)));this.bytes.push(e)}addString(e,t){this.bytes.push(e.charCodeAt(0));e=serializeString(t);this.bytes.push(e)}complete(){if(!this.bytes.length)throw new Error("Buffer is empty");if("completed"!==this.status){this.status="completed";var t=this.bytes.getBuffer();if(t.length+commandFramesLength<=this.maxChunkLength)this.resultBuffers.push(frameBuffer(t,commandFrameStart,commandFrameEnd));else{let e=Math.ceil(t.length/this.maxChunkLength);Math.ceil(t.length/e)+commandFramesLength>this.maxChunkLength&&e++;for(var[n,r]of splitBufferToEqualChunks(t,e))0===n?this.resultBuffers.push(frameBuffer(r,commandFrameStart,commandDivFrameEnd)):n===e-1?this.resultBuffers.push(frameBuffer(r,commandDivFrameStart,commandFrameEnd)):this.resultBuffers.push(frameBuffer(r,commandDivFrameStart,commandDivFrameEnd))}}}getResultBuffers(){if("creating"!==this.status&&this.resultBuffers.length)return this.resultBuffers;throw new Error("Command is not complete.")}}function deserializeCommand(e){var[t]=e;const n={c:t};let r=1;for(;r<e.length;){var s=String.fromCharCode(e[r]);switch(getDataTypeFromByte(e[++r])){case SerializedItem.Int:var{number:i,byteLength:o}=deserializeInt(e.slice(r));n[s]=Number(i),r+=o;break;case SerializedItem.SimilarIntArray:{const{numbers:a,byteLength:d}=deserializeSimilarIntArray(e.slice(r));n[s]=a.map(e=>Number(e)),r+=d}break;case SerializedItem.String:var{string:i,byteLength:o}=deserializeString(e.slice(r));n[s]=i,r+=o}}return n}function getDataTypeFromByte(e){e>>=4;if(e<=SerializedItem.Min||SerializedItem.Max<=e)throw new Error("Not existing type");return e}function stringToUtf8CodesBuffer(t,e){if(t.length!==e)throw new Error("Wrong string length");const n=new Uint8Array(e);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}function*splitBufferToEqualChunks(t,n){var r=Math.ceil(t.length/n);for(let e=0;e<n;e++)yield[e,t.slice(e*r,(e+1)*r)]}function frameBuffer(e,t,n){const r=new Uint8Array(e.length+t.length+n.length);return r.set(t),r.set(e,t.length),r.set(n,t.length+e.length),r}function areBuffersEqual(t,n,r){for(let e=0;e<r;e++)if(t[e]!==n[e])return!1;return!0}function serializeSegmentAnnouncementCommand(e,t){var{c:e,p:n,l:r}=e;const s=new BinaryCommandCreator(e,t);return null!=r&&r.length&&s.addSimilarIntArr("l",r),null!=n&&n.length&&s.addSimilarIntArr("p",n),s.complete(),s.getResultBuffers()}function serializePeerSegmentCommand(e,t){const n=new BinaryCommandCreator(e.c,t);return n.addInteger("i",e.i),n.addInteger("r",e.r),n.complete(),n.getResultBuffers()}function serializePeerSendSegmentCommand(e,t){const n=new BinaryCommandCreator(e.c,t);return n.addInteger("i",e.i),n.addInteger("s",e.s),n.addInteger("r",e.r),n.complete(),n.getResultBuffers()}function serializePeerSegmentRequestCommand(e,t){const n=new BinaryCommandCreator(e.c,t);return n.addInteger("i",e.i),n.addInteger("r",e.r),e.b&&n.addInteger("b",e.b),n.complete(),n.getResultBuffers()}function serializePeerCommand(e,t){switch(e.c){case PeerCommandType$1.CancelSegmentRequest:case PeerCommandType$1.SegmentAbsent:case PeerCommandType$1.SegmentDataSendingCompleted:return serializePeerSegmentCommand(e,t);case PeerCommandType$1.SegmentRequest:return serializePeerSegmentRequestCommand(e,t);case PeerCommandType$1.SegmentsAnnouncement:return serializeSegmentAnnouncementCommand(e,t);case PeerCommandType$1.SegmentData:return serializePeerSendSegmentCommand(e,t)}}const Command=Object.freeze(Object.defineProperty({__proto__:null,BinaryCommandChunksJoiner:BinaryCommandChunksJoiner,BinaryCommandJoiningError:BinaryCommandJoiningError,PeerCommandType:PeerCommandType$1,deserializeCommand:deserializeCommand,isCommandChunk:isCommandChunk,serializePeerCommand:serializePeerCommand},Symbol.toStringTag,{value:"Module"}));class PeerProtocol{constructor(e,t,n,r){__publicField(this,"commandChunks"),__publicField(this,"uploadingContext"),__publicField(this,"onChunkDownloaded"),__publicField(this,"onChunkUploaded"),__publicField(this,"onDataReceived",e=>{isCommandChunk(e)?this.receivingCommandBytes(e):(this.eventHandlers.onSegmentChunkReceived(e),this.onChunkDownloaded(e.byteLength,"p2p",this.connection.idUtf8))}),this.connection=e,this.peerConfig=t,this.eventHandlers=n,this.onChunkDownloaded=r.getEventDispatcher("onChunkDownloaded"),this.onChunkUploaded=r.getEventDispatcher("onChunkUploaded"),e.on("data",this.onDataReceived)}sendCommand(e){for(const t of serializePeerCommand(e,this.peerConfig.webRtcMaxMessageSize))this.connection.write(t)}stopUploadingSegmentData(){var e;null!=(e=this.uploadingContext)&&e.stopUploading(),this.uploadingContext=void 0}getUploadingRequestId(){var e;return null==(e=this.uploadingContext)?void 0:e.requestId}async splitSegmentDataToChunksAndUploadAsync(e,t){if(this.uploadingContext)throw new Error("Some segment data is already uploading.");const n=getBufferChunks(e,this.peerConfig.webRtcMaxMessageSize),{promise:r,resolve:s,reject:i}=getControlledPromise();let o=!1;e={stopUploading:()=>{o=!1},requestId:t},this.uploadingContext=e,t=()=>{if(o)for(;;){var e=n.next().value;if(!e){s();break}var t=this.connection.write(e);if(this.onChunkUploaded(e.byteLength,this.connection.idUtf8),!t)break}else i()};try{this.connection.on("drain",t),o=!0,t(),await r}finally{this.connection.off("drain",t),this.uploadingContext===e&&(this.uploadingContext=void 0)}}receivingCommandBytes(e){this.commandChunks||(this.commandChunks=new BinaryCommandChunksJoiner(e=>{this.commandChunks=void 0;e=deserializeCommand(e);this.eventHandlers.onCommandReceived(e)}));try{this.commandChunks.addCommandChunk(e)}catch(e){if(!(e instanceof BinaryCommandJoiningError))return;this.commandChunks=void 0}}}function*getBufferChunks(e,t){let n=e.byteLength;for(;0<n;){var r=n>=t?t:n,s=e.byteLength-n,s=e.slice(s,s+r);n-=r,yield s}}const PeerCommandType=Command["PeerCommandType"];class Peer2{constructor(e,t,n,r,s){__publicField(this,"id"),__publicField(this,"peerProtocol"),__publicField(this,"downloadingContext"),__publicField(this,"loadedSegments",new Set),__publicField(this,"httpLoadingSegments",new Set),__publicField(this,"downloadingErrors",[]),__publicField(this,"logger",debug$3("p2pml-core:peer")),__publicField(this,"onPeerClosed"),__publicField(this,"onCommandReceived",async e=>{var t;switch(e.c){case PeerCommandType.SegmentsAnnouncement:this.loadedSegments=new Set(e.l),this.httpLoadingSegments=new Set(e.p),this.eventHandlers.onSegmentsAnnouncement();break;case PeerCommandType.SegmentRequest:this.peerProtocol.stopUploadingSegmentData(),this.eventHandlers.onSegmentRequested(this,e.i,e.r,e.b);break;case PeerCommandType.SegmentData:{if(!this.downloadingContext)break;if(this.downloadingContext.isSegmentDataCommandReceived)break;const{request:s,controls:i,requestId:o}=this.downloadingContext;if(s.segment.externalId!==e.i||o!==e.r)break;this.downloadingContext.isSegmentDataCommandReceived=!0,i.firstBytesReceived(),void 0===s.totalBytes?s.setTotalBytes(e.s):s.totalBytes-s.loadedBytes!==e.s&&(s.clearLoadedBytes(),this.sendCancelSegmentRequestCommand(s.segment,o),this.cancelSegmentDownloading("peer-response-bytes-length-mismatch"),this.destroy())}break;case PeerCommandType.SegmentDataSendingCompleted:{var n=this.downloadingContext;if(null==n||!n.isSegmentDataCommandReceived)return;const{request:a,controls:d}=n;if(n.request.segment.externalId!==e.i||n.requestId!==e.r)return a.clearLoadedBytes(),this.cancelSegmentDownloading("peer-protocol-violation"),void this.destroy();if(a.loadedBytes!==a.totalBytes)return a.clearLoadedBytes(),this.cancelSegmentDownloading("peer-response-bytes-length-mismatch"),void this.destroy();var r=await(null==(r=(t=this.peerConfig).validateP2PSegment)?void 0:r.call(t,a.segment.url,a.segment.byteRange))??!0;if(this.downloadingContext!==n)return;if(!r)return a.clearLoadedBytes(),this.cancelSegmentDownloading("p2p-segment-validation-failed"),void this.destroy();this.downloadingErrors=[],d.completeOnSuccess(),this.downloadingContext=void 0;break}case PeerCommandType.SegmentAbsent:(null==(t=this.downloadingContext)?void 0:t.request.segment.externalId)===e.i&&(null==(n=this.downloadingContext)?void 0:n.requestId)===e.r&&(this.cancelSegmentDownloading("peer-segment-absent"),this.loadedSegments.delete(e.i));break;case PeerCommandType.CancelSegmentRequest:if(this.peerProtocol.getUploadingRequestId()!==e.r)break;this.peerProtocol.stopUploadingSegmentData()}}),__publicField(this,"onSegmentChunkReceived",e=>{var t;if(null!=(t=this.downloadingContext)&&t.isSegmentDataCommandReceived){const{request:n,controls:r}=this.downloadingContext;if(void 0!==n.totalBytes&&n.loadedBytes+e.byteLength>n.totalBytes)return n.clearLoadedBytes(),this.cancelSegmentDownloading("peer-response-bytes-length-mismatch"),void this.destroy();r.addLoadedChunk(e)}}),__publicField(this,"onPeerConnectionClosed",()=>{this.destroy()}),__publicField(this,"onConnectionError",e=>{this.logger(`peer connection error ${this.id} %O`,e),this.eventTarget.getEventDispatcher("onPeerError")({peerId:this.id,streamType:this.streamType,error:e});e=e.code;"ERR_DATA_CHANNEL"!==e&&"ERR_CONNECTION_FAILURE"!==e||this.destroy()}),__publicField(this,"destroy",()=>{this.cancelSegmentDownloading("peer-closed"),this.connection.destroy(),this.eventHandlers.onPeerClosed(this),this.onPeerClosed({peerId:this.id,streamType:this.streamType}),this.logger("peer closed "+this.id)}),this.connection=e,this.eventHandlers=t,this.peerConfig=n,this.streamType=r,this.eventTarget=s,this.onPeerClosed=s.getEventDispatcher("onPeerClose"),this.id=Peer2.getPeerIdFromConnection(e),this.peerProtocol=new PeerProtocol(e,n,{onSegmentChunkReceived:this.onSegmentChunkReceived,onCommandReceived:this.onCommandReceived},s),s.getEventDispatcher("onPeerConnect")({peerId:this.id,streamType:r}),e.on("error",this.onConnectionError),e.on("close",this.onPeerConnectionClosed),e.on("end",this.onPeerConnectionClosed),e.on("finish",this.onPeerConnectionClosed)}get downloadingSegment(){var e;return null==(e=this.downloadingContext)?void 0:e.request.segment}getSegmentStatus(e){e=e.externalId;return this.loadedSegments.has(e)?"loaded":this.httpLoadingSegments.has(e)?"http-loading":void 0}downloadSegment(e){if(this.downloadingContext)throw new Error("Some segment already is downloading");this.downloadingContext={request:e,requestId:Math.floor(1e3*Math.random()),isSegmentDataCommandReceived:!1,controls:e.start({downloadSource:"p2p",peerId:this.id},{notReceivingBytesTimeoutMs:this.peerConfig.p2pNotReceivingBytesTimeoutMs,abort:e=>{var t,n;this.downloadingContext&&({request:n,requestId:t}=this.downloadingContext,this.sendCancelSegmentRequestCommand(n.segment,t),this.downloadingErrors.push(e),this.downloadingContext=void 0,n=this.downloadingErrors.filter(e=>"bytes-receiving-timeout"===e.type),this.peerConfig.p2pErrorRetries<=n.length&&this.destroy())}})};const t={c:PeerCommandType.SegmentRequest,r:this.downloadingContext.requestId,i:e.segment.externalId};e.loadedBytes&&(t.b=e.loadedBytes),this.peerProtocol.sendCommand(t)}async uploadSegmentData(e,t,n){var r=e["externalId"],s=(this.logger(`send segment ${e.externalId} to `+this.id),{c:PeerCommandType.SegmentData,i:r,r:t,s:n.byteLength});this.peerProtocol.sendCommand(s);try{await this.peerProtocol.splitSegmentDataToChunksAndUploadAsync(n,t),this.sendSegmentDataSendingCompletedCommand(e,t),this.logger(`segment ${r} has been sent to `+this.id)}catch{this.logger("cancel segment uploading "+r)}}cancelSegmentDownloading(e){if(this.downloadingContext){const{request:n,controls:r}=this.downloadingContext;var t=n["segment"],t=(this.logger(`cancel segment request ${t.externalId} (${e})`),new RequestError(e));r.abortOnError(t),this.downloadingContext=void 0,this.downloadingErrors.push(t)}}sendSegmentsAnnouncementCommand(e,t){t={c:PeerCommandType.SegmentsAnnouncement,p:t,l:e};this.peerProtocol.sendCommand(t)}sendSegmentAbsentCommand(e,t){this.peerProtocol.sendCommand({c:PeerCommandType.SegmentAbsent,i:e,r:t})}sendCancelSegmentRequestCommand(e,t){this.peerProtocol.sendCommand({c:PeerCommandType.CancelSegmentRequest,i:e.externalId,r:t})}sendSegmentDataSendingCompletedCommand(e,t){this.peerProtocol.sendCommand({c:PeerCommandType.SegmentDataSendingCompleted,r:t,i:e.externalId})}static getPeerIdFromConnection(e){return hexToUtf8(e.id)}}function isSafariOrWkWebview(){var e=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),t=/\b(iPad|iPhone|Macintosh).*AppleWebKit(?!.*Safari)/i.test(navigator.userAgent);return e||t}class P2PTrackerClient{constructor(e,t,n,r,s){__publicField(this,"streamShortId"),__publicField(this,"client"),__publicField(this,"_peers",new Map),__publicField(this,"logger",debug$3("p2pml-core:p2p-tracker-client")),__publicField(this,"onReceivePeerConnection",t=>{var e=Peer2.getPeerIdFromConnection(t);let n=this._peers.get(e);null!=n&&n.peer?t.destroy():(n||(n={potentialConnections:new Set},t.idUtf8=e,n.potentialConnections.add(t),this._peers.set(e,n)),t.on("connect",()=>{if(n&&!n.peer){for(const e of n.potentialConnections)e!==t&&e.destroy();n.potentialConnections.clear(),n.peer=new Peer2(t,{onPeerClosed:this.onPeerClosed,onSegmentRequested:this.eventHandlers.onSegmentRequested,onSegmentsAnnouncement:this.eventHandlers.onSegmentsAnnouncement},this.config,this.stream.type,this.eventTarget),this.logger(`connected with peer: ${n.peer.id} `+this.streamShortId),this.eventHandlers.onPeerConnected(n.peer)}}))}),__publicField(this,"onTrackerClientWarning",e=>{this.logger(`tracker warning (${this.streamShortId}: ${e})`),this.eventTarget.getEventDispatcher("onTrackerWarning")({streamType:this.stream.type,warning:e})}),__publicField(this,"onTrackerClientError",e=>{this.logger(`tracker error (${this.streamShortId}: ${e})`),this.eventTarget.getEventDispatcher("onTrackerError")({streamType:this.stream.type,error:e})}),__publicField(this,"onPeerClosed",e=>{this.logger("peer closed: "+e.id),this._peers.delete(e.id)}),this.stream=t,this.eventHandlers=n,this.config=r,this.eventTarget=s;n=getStreamHash(e),this.streamShortId=getStreamString(t),s=generatePeerId(r.trackerClientVersionPrefix);this.client=new Client({infoHash:utf8ToUintArray(n),peerId:utf8ToUintArray(s),announce:isSafariOrWkWebview()?r.announceTrackers.slice(0,1):r.announceTrackers,rtcConfig:this.config.rtcConfig}),this.client.on("peer",this.onReceivePeerConnection),this.client.on("warning",this.onTrackerClientWarning),this.client.on("error",this.onTrackerClientError),this.logger(`create new client; 
stream: ${this.streamShortId}; hash: ${n}
peerId: `+s)}start(){this.client.start()}destroy(){this.client.destroy();for(var{peer:e,potentialConnections:t}of this._peers.values()){null!=e&&e.destroy();for(const n of t)n.destroy()}this._peers.clear(),this.logger("destroy client; stream: "+this.streamShortId)}*peers(){for(const e of this._peers.values())null!=e&&e.peer&&(yield e.peer)}}const PEER_PROTOCOL_VERSION="v2";function getStreamSwarmId(e,t){return PEER_PROTOCOL_VERSION+`-${e}-`+getStreamId(t)}function getSegmentFromStreamsMap(e,t){for(const r of e.values()){var n=r.segments.get(t);if(n)return n}}function getSegmentFromStreamByExternalId(e,t){for(const n of e.segments.values())if(n.externalId===t)return n}function getStreamId(e){return e.type+"-"+e.index}function getSegmentAvgDuration(e){const t=e["segments"];let n=0;e=t.size;for(const s of t.values()){var r=s.endTime-s.startTime;n+=r}return n/e}function calculateTimeWindows(e,t){var{highDemandTimeWindow:e,httpDownloadTimeWindow:n,p2pDownloadTimeWindow:r}=e;const s={highDemandTimeWindow:e,httpDownloadTimeWindow:n,p2pDownloadTimeWindow:r};return t<=5?(s.httpDownloadTimeWindow=0,s.p2pDownloadTimeWindow=0):t<=10&&(s.p2pDownloadTimeWindow=s.httpDownloadTimeWindow),s}function getSegmentPlaybackStatuses(e,t,n,r,s){var{highDemandTimeWindow:n,httpDownloadTimeWindow:s,p2pDownloadTimeWindow:i}=calculateTimeWindows(n,s);return{isHighDemand:isSegmentInTimeWindow(e,t,n),isHttpDownloadable:isSegmentInTimeWindow(e,t,s),isP2PDownloadable:isSegmentInTimeWindow(e,t,i)&&r.isSegmentLoadingOrLoadedBySomeone(e)}}function isSegmentInTimeWindow(e,t,n){var{startTime:e,endTime:r}=e,{position:t,rate:s}=t;return!(t+n*s<e||r<t)}class P2PLoader{constructor(e,t,n,r,s,i,o){__publicField(this,"trackerClient"),__publicField(this,"isAnnounceMicrotaskCreated",!1),__publicField(this,"onPeerConnected",e=>{var{httpLoading:t,loaded:n}=this.getSegmentsAnnouncement();e.sendSegmentsAnnouncementCommand(n,t)}),__publicField(this,"broadcastAnnouncement",()=>{this.isAnnounceMicrotaskCreated||(this.isAnnounceMicrotaskCreated=!0,queueMicrotask(()=>{var{httpLoading:e,loaded:t}=this.getSegmentsAnnouncement();for(const n of this.trackerClient.peers())n.sendSegmentsAnnouncementCommand(t,e);this.isAnnounceMicrotaskCreated=!1}))}),__publicField(this,"onSegmentRequested",async(e,t,n,r)=>{var s=getSegmentFromStreamByExternalId(this.stream,t);if(s){var i=this.config.swarmId??this.streamManifestUrl,o=getStreamSwarmId(i,this.stream);const a=await this.segmentStorage.getSegmentData(i,o,s.externalId);a?await e.uploadSegmentData(s,n,void 0!==r?a.slice(r):a):e.sendSegmentAbsentCommand(t,n)}}),this.streamManifestUrl=e,this.stream=t,this.requests=n,this.segmentStorage=r,this.config=s,this.eventTarget=i,this.onSegmentAnnouncement=o;e=getStreamSwarmId(this.config.swarmId??this.streamManifestUrl,this.stream);this.trackerClient=new P2PTrackerClient(e,this.stream,{onPeerConnected:this.onPeerConnected,onSegmentRequested:this.onSegmentRequested,onSegmentsAnnouncement:this.onSegmentAnnouncement},this.config,this.eventTarget),this.eventTarget.addEventListener("onStorageUpdated-"+e,this.broadcastAnnouncement),this.segmentStorage.setSegmentChangeCallback(e=>{this.eventTarget.dispatchEvent("onStorageUpdated-"+e)}),this.trackerClient.start()}downloadSegment(e){const t=[];for(const s of this.trackerClient.peers())s.downloadingSegment||"loaded"!==s.getSegmentStatus(e)||t.push(s);const n=getRandomItem(t);var r;n&&(r=this.requests.getOrCreateRequest(e),n.downloadSegment(r))}isSegmentLoadingOrLoadedBySomeone(e){for(const t of this.trackerClient.peers())if(t.getSegmentStatus(e))return!0;return!1}isSegmentLoadedBySomeone(e){for(const t of this.trackerClient.peers())if("loaded"===t.getSegmentStatus(e))return!0;return!1}get connectedPeerCount(){let e=0;for(const t of this.trackerClient.peers())e++;return e}getSegmentsAnnouncement(){var e=this.config.swarmId??this.streamManifestUrl,t=getStreamSwarmId(e,this.stream),e=this.segmentStorage.getStoredSegmentIds(e,t);const n=[];for(const s of this.requests.httpRequests()){var r=this.stream.segments.get(s.segment.runtimeId);r&&n.push(r.externalId)}return{loaded:e,httpLoading:n}}destroy(){var e=getStreamSwarmId(this.config.swarmId??this.streamManifestUrl,this.stream);this.eventTarget.removeEventListener("onStorageUpdated-"+e,this.broadcastAnnouncement),this.trackerClient.destroy()}}class P2PLoadersContainer{constructor(e,t,n,r,s,i,o){__publicField(this,"loaders",new Map),__publicField(this,"_currentLoaderItem"),__publicField(this,"logger",debug$3("p2pml-core:p2p-loaders-container")),this.streamManifestUrl=e,this.requests=n,this.segmentStorage=r,this.config=s,this.eventTarget=i,this.onSegmentAnnouncement=o,this.changeCurrentLoader(t)}createLoader(e){if(this.loaders.has(e.runtimeId))throw new Error("Loader for this stream already exists");const t=new P2PLoader(this.streamManifestUrl,e,this.requests,this.segmentStorage,this.config,this.eventTarget,()=>{this._currentLoaderItem.loader===t&&this.onSegmentAnnouncement()});var n=getStreamString(e);return this.logger("created new loader: "+n),{loader:t,stream:e,loggerInfo:getStreamString(e)}}changeCurrentLoader(e){const t=this.loaders.get(e.runtimeId);var n,r;this._currentLoaderItem&&(n=getStreamSwarmId(r=this.config.swarmId??this.streamManifestUrl,this._currentLoaderItem.stream),this.segmentStorage.getStoredSegmentIds(r,n).length?this.setLoaderDestroyTimeout(this._currentLoaderItem):this.destroyAndRemoveLoader(this._currentLoaderItem)),t?(this._currentLoaderItem=t,clearTimeout(t.destroyTimeoutId),t.destroyTimeoutId=void 0):(r=this.createLoader(e),this.loaders.set(e.runtimeId,r),this._currentLoaderItem=r),this.logger("change current p2p loader: "+getStreamString(e))}setLoaderDestroyTimeout(e){e.destroyTimeoutId=window.setTimeout(()=>this.destroyAndRemoveLoader(e),this.config.p2pInactiveLoaderDestroyTimeoutMs)}destroyAndRemoveLoader(e){e.loader.destroy(),this.loaders.delete(e.stream.runtimeId),this.logger("destroy p2p loader: ",e.loggerInfo)}get currentLoader(){return this._currentLoaderItem.loader}destroy(){for(var{loader:e,destroyTimeoutId:t}of this.loaders.values())e.destroy(),clearTimeout(t);this.loaders.clear()}}let Request$1=class{constructor(e,t,n,r,s,i){__publicField(this,"currentAttempt"),__publicField(this,"_failedAttempts",new FailedRequestAttempts),__publicField(this,"finalData"),__publicField(this,"bytes",[]),__publicField(this,"_loadedBytes",0),__publicField(this,"_totalBytes"),__publicField(this,"_status","not-started"),__publicField(this,"progress"),__publicField(this,"notReceivingBytesTimeout"),__publicField(this,"_abortRequestCallback"),__publicField(this,"_logger"),__publicField(this,"_isHandledByProcessQueue",!1),__publicField(this,"onSegmentError"),__publicField(this,"onSegmentAbort"),__publicField(this,"onSegmentStart"),__publicField(this,"onSegmentLoaded"),__publicField(this,"abortOnTimeout",()=>{var e,t;this.throwErrorIfNotLoadingStatus(),this.currentAttempt&&(this.setStatus("failed"),t=new RequestError("bytes-receiving-timeout"),null!=(e=this._abortRequestCallback)&&e.call(this,t),this.logger(this.downloadSource+` ${this.segment.externalId} failed `+t.type),this._failedAttempts.add({...this.currentAttempt,error:t}),this.onSegmentError({segment:this.segment,error:t,downloadSource:this.currentAttempt.downloadSource,peerId:"p2p"===this.currentAttempt.downloadSource?this.currentAttempt.peerId:void 0,streamType:this.segment.stream.type}),this.notReceivingBytesTimeout.clear(),this.manageBandwidthCalculatorsState("stop"),this.requestProcessQueueCallback())}),__publicField(this,"abortOnError",e=>{this.throwErrorIfNotLoadingStatus(),this.currentAttempt&&(this.setStatus("failed"),this.logger(this.downloadSource+` ${this.segment.externalId} failed `+e.type),this._failedAttempts.add({...this.currentAttempt,error:e}),this.onSegmentError({segment:this.segment,error:e,downloadSource:this.currentAttempt.downloadSource,peerId:"p2p"===this.currentAttempt.downloadSource?this.currentAttempt.peerId:void 0,streamType:this.segment.stream.type}),this.notReceivingBytesTimeout.clear(),this.manageBandwidthCalculatorsState("stop"),this.requestProcessQueueCallback())}),__publicField(this,"completeOnSuccess",()=>{this.throwErrorIfNotLoadingStatus(),this.currentAttempt&&(this.manageBandwidthCalculatorsState("stop"),this.notReceivingBytesTimeout.clear(),this.finalData=joinChunks(this.bytes),this.setStatus("succeed"),this._totalBytes=this._loadedBytes,this.onSegmentLoaded({segmentUrl:this.segment.url,bytesLength:this.finalData.byteLength,downloadSource:this.currentAttempt.downloadSource,peerId:"p2p"===this.currentAttempt.downloadSource?this.currentAttempt.peerId:void 0,streamType:this.segment.stream.type}),this.logger(this.currentAttempt.downloadSource+` ${this.segment.externalId} succeed`),this.requestProcessQueueCallback())}),__publicField(this,"addLoadedChunk",e=>{if(this.throwErrorIfNotLoadingStatus(),this.currentAttempt&&this.progress){this.notReceivingBytesTimeout.restart();var t=e.byteLength;const{all:n,http:r}=this.bandwidthCalculators;n.addBytes(t),"http"===this.currentAttempt.downloadSource&&r.addBytes(t),this.bytes.push(e),this.progress.lastLoadedChunkTimestamp=performance.now(),this.progress.loadedBytes+=t,this._loadedBytes+=t}}),__publicField(this,"firstBytesReceived",()=>{this.throwErrorIfNotLoadingStatus(),this.notReceivingBytesTimeout.restart()}),this.segment=e,this.requestProcessQueueCallback=t,this.bandwidthCalculators=n,this.playback=r,this.playbackConfig=s,this.onSegmentError=i.getEventDispatcher("onSegmentError"),this.onSegmentAbort=i.getEventDispatcher("onSegmentAbort"),this.onSegmentStart=i.getEventDispatcher("onSegmentStart"),this.onSegmentLoaded=i.getEventDispatcher("onSegmentLoaded");e=this.segment.byteRange,e&&({end:t,start:n}=e,this._totalBytes=t-n+1),this.notReceivingBytesTimeout=new Timeout(this.abortOnTimeout),r=this.segment.stream.type;this._logger=debug$3("p2pml-core:request-"+r)}clearLoadedBytes(){this._loadedBytes=0,this.bytes=[],this._totalBytes=void 0}get status(){return this._status}setStatus(e){this._status=e,this._isHandledByProcessQueue=!1}get downloadSource(){var e;return null==(e=this.currentAttempt)?void 0:e.downloadSource}get loadedBytes(){return this._loadedBytes}get totalBytes(){return this._totalBytes}get data(){if("succeed"===this.status)return this.finalData||(this.finalData=joinChunks(this.bytes)),this.finalData}get failedAttempts(){return this._failedAttempts}get isHandledByProcessQueue(){return this._isHandledByProcessQueue}markHandledByProcessQueue(){this._isHandledByProcessQueue=!0}setTotalBytes(e){if(void 0!==this._totalBytes)throw new Error("Request total bytes value is already set");this._totalBytes=e}start(e,t){if("succeed"===this._status)throw new Error(`Request ${this.segment.externalId} has been already succeed.`);if("loading"===this._status)throw new Error(`Request ${this.segment.externalId} has been already started.`);this.setStatus("loading"),this.currentAttempt={...e},this.progress={startFromByte:this._loadedBytes,loadedBytes:0,startTimestamp:performance.now()},this.manageBandwidthCalculatorsState("start");var{notReceivingBytesTimeoutMs:t,abort:n}=t;return this._abortRequestCallback=n,void 0!==t&&this.notReceivingBytesTimeout.start(t),this.logger(e.downloadSource+` ${this.segment.externalId} started`),this.onSegmentStart({segment:this.segment,downloadSource:e.downloadSource,peerId:"p2p"===e.downloadSource?e.peerId:void 0}),{firstBytesReceived:this.firstBytesReceived,addLoadedChunk:this.addLoadedChunk,completeOnSuccess:this.completeOnSuccess,abortOnError:this.abortOnError}}abortFromProcessQueue(){var e;this.throwErrorIfNotLoadingStatus(),this.setStatus("aborted"),this.logger(`${null==(e=this.currentAttempt)?void 0:e.downloadSource} ${this.segment.externalId} aborted`),null!=(e=this._abortRequestCallback)&&e.call(this,new RequestError("abort")),this.onSegmentAbort({segment:this.segment,downloadSource:null==(e=this.currentAttempt)?void 0:e.downloadSource,peerId:"p2p"===(null==(e=this.currentAttempt)?void 0:e.downloadSource)?this.currentAttempt.peerId:void 0,streamType:this.segment.stream.type}),this._abortRequestCallback=void 0,this.manageBandwidthCalculatorsState("stop"),this.notReceivingBytesTimeout.clear()}throwErrorIfNotLoadingStatus(){if("loading"!==this._status)throw new Error(`Request has been already ${this.status}.`)}logger(e){var t;this._logger.color="http"===(null==(t=this.currentAttempt)?void 0:t.downloadSource)?"green":"red",this._logger(e),this._logger.color=""}manageBandwidthCalculatorsState(e){var t;const{all:n,http:r}=this.bandwidthCalculators;e="start"===e?"startLoading":"stopLoading";"http"===(null==(t=this.currentAttempt)?void 0:t.downloadSource)&&r[e](),n[e]()}};class FailedRequestAttempts{constructor(){__publicField(this,"attempts",[])}add(e){this.attempts.push(e)}get httpAttemptsCount(){return this.attempts.reduce((e,t)=>"http"===t.downloadSource?e+1:e,0)}get lastAttempt(){return this.attempts[this.attempts.length-1]}clear(){this.attempts=[]}}class Timeout{constructor(e){__publicField(this,"timeoutId"),__publicField(this,"ms"),this.action=e}start(e){if(this.timeoutId)throw new Error("Timeout is already started.");this.ms=e,this.timeoutId=window.setTimeout(this.action,this.ms)}restart(e){this.timeoutId&&clearTimeout(this.timeoutId),e&&(this.ms=e),this.ms&&(this.timeoutId=window.setTimeout(this.action,this.ms))}clear(){clearTimeout(this.timeoutId),this.timeoutId=void 0}}class RequestsContainer{constructor(e,t,n,r,s){__publicField(this,"requests",new Map),this.requestProcessQueueCallback=e,this.bandwidthCalculators=t,this.playback=n,this.config=r,this.eventTarget=s}get executingHttpCount(){let e=0;for(const t of this.httpRequests())"loading"===t.status&&e++;return e}get executingP2PCount(){let e=0;for(const t of this.p2pRequests())"loading"===t.status&&e++;return e}get(e){return this.requests.get(e)}getOrCreateRequest(e){let t=this.requests.get(e);return t||(t=new Request$1(e,this.requestProcessQueueCallback,this.bandwidthCalculators,this.playback,this.config,this.eventTarget),this.requests.set(e,t)),t}remove(e){this.requests.delete(e.segment)}items(){return this.requests.values()}*httpRequests(){for(const e of this.requests.values())"http"===e.downloadSource&&(yield e)}*p2pRequests(){for(const e of this.requests.values())"p2p"===e.downloadSource&&(yield e)}destroy(){for(const e of this.requests.values())"loading"===e.status&&e.abortFromProcessQueue();this.requests.clear()}}class EngineRequest{constructor(e,t){__publicField(this,"_status","pending"),__publicField(this,"_shouldBeStartedImmediately",!1),this.segment=e,this.engineCallbacks=t}get status(){return this._status}get shouldBeStartedImmediately(){return this._shouldBeStartedImmediately}resolve(e,t){"pending"===this._status&&(this._status="succeed",this.engineCallbacks.onSuccess({data:e,bandwidth:t}))}reject(){"pending"===this._status&&(this._status="failed",this.engineCallbacks.onError(new CoreRequestError("failed")))}abort(){"pending"===this._status&&(this._status="aborted",this.engineCallbacks.onError(new CoreRequestError("aborted")))}markAsShouldBeStartedImmediately(){this._shouldBeStartedImmediately=!0}}function*generateQueue(t,n,r,s,i){const{runtimeId:e,stream:o}=t;var a=o.segments.get(e);if(a){const c=o.segments.values();let e;do{var d=c.next();if(d.done)return;e=d.value}while(e!==a);const u=getSegmentPlaybackStatuses(e,n,r,s,i);if(isNotActualStatuses(u)){t=c.next();if(t.done)return;var t=t.value,h=getSegmentPlaybackStatuses(t,n,r,s,i);if(isNotActualStatuses(h))return;u.isHighDemand=!0,yield{segment:e,statuses:u},yield{segment:t,statuses:h}}else yield{segment:e,statuses:u};for(const m of c){var l=getSegmentPlaybackStatuses(m,n,r,s,i);if(isNotActualStatuses(l))break;yield{segment:m,statuses:l}}}}function isNotActualStatuses(e){var{isHighDemand:e=!1,isHttpDownloadable:t=!1,isP2PDownloadable:n=!1}=e;return!e&&!t&&!n}const FAILED_ATTEMPTS_CLEAR_INTERVAL=6e4,PEER_UPDATE_LATENCY=1e3;class HybridLoader{constructor(e,t,n,r,s,i,o){__publicField(this,"requests"),__publicField(this,"engineRequest"),__publicField(this,"p2pLoaders"),__publicField(this,"playback"),__publicField(this,"segmentAvgDuration"),__publicField(this,"logger"),__publicField(this,"storageCleanUpIntervalId"),__publicField(this,"levelChangedTimestamp"),__publicField(this,"lastQueueProcessingTimeStamp"),__publicField(this,"randomHttpDownloadInterval"),__publicField(this,"isProcessQueueMicrotaskCreated",!1),__publicField(this,"requestProcessQueueMicrotask",(e=!0)=>{const t=performance.now();!e&&void 0!==this.lastQueueProcessingTimeStamp&&t-this.lastQueueProcessingTimeStamp<=1e3||this.isProcessQueueMicrotaskCreated||(this.isProcessQueueMicrotaskCreated=!0,queueMicrotask(()=>{try{this.processQueue(),this.lastQueueProcessingTimeStamp=t}finally{this.isProcessQueueMicrotaskCreated=!1}}))}),this.streamManifestUrl=e,this.lastRequestedSegment=t,this.streamDetails=n,this.config=r,this.bandwidthCalculators=s,this.segmentStorage=i,this.eventTarget=o;e=this.lastRequestedSegment.stream;if(this.playback={position:this.lastRequestedSegment.startTime,rate:1},this.segmentAvgDuration=getSegmentAvgDuration(e),this.requests=new RequestsContainer(this.requestProcessQueueMicrotask,this.bandwidthCalculators,this.playback,this.config,this.eventTarget),!this.segmentStorage)throw new Error("Segment storage is not initialized.");this.p2pLoaders=new P2PLoadersContainer(this.streamManifestUrl,this.lastRequestedSegment.stream,this.requests,this.segmentStorage,this.config,this.eventTarget,this.requestProcessQueueMicrotask),this.logger=debug$3("p2pml-core:hybrid-loader-"+e.type),this.logger.color="coral",this.setIntervalLoading()}setIntervalLoading(){var e=this.p2pLoaders.currentLoader.connectedPeerCount,e=Math.random()*PEER_UPDATE_LATENCY*e+PEER_UPDATE_LATENCY;this.randomHttpDownloadInterval=window.setTimeout(()=>{this.loadRandomThroughHttp(),this.setIntervalLoading()},e)}async loadSegment(e,t){this.logger("requests: "+getSegmentString(e));var n=e["stream"],r=(n!==this.lastRequestedSegment.stream&&(this.logger("stream changed to "+getStreamString(n)),this.p2pLoaders.changeCurrentLoader(n)),this.lastRequestedSegment=e,this.config.swarmId??this.streamManifestUrl),s=getStreamSwarmId(r,n);this.segmentStorage.onSegmentRequested(r,s,e.externalId,e.startTime,e.endTime,n.type,this.streamDetails.isLive);const i=new EngineRequest(e,t);try{if(this.segmentStorage.hasSegment(r,s,e.externalId)){var o,a=await this.segmentStorage.getSegmentData(r,s,e.externalId);if(a)return o=this.generateQueue()["queueDownloadRatio"],void i.resolve(a,this.getBandwidth(o))}this.engineRequest=i}catch{i.reject()}finally{this.requestProcessQueueMicrotask()}}processRequests(e,t){const n=this.lastRequestedSegment["stream"];var r=this.config["httpErrorRetries"],s=performance.now();for(const u of this.requests.items()){var{downloadSource:i,status:o,segment:a,isHandledByProcessQueue:d}=u;const m=(null==(c=this.engineRequest)?void 0:c.segment)===a?this.engineRequest:void 0;switch(o){case"loading":e.has(a.runtimeId)||m||(u.abortFromProcessQueue(),this.requests.remove(u));break;case"succeed":if(!u.data||!i)break;"http"===i&&this.p2pLoaders.currentLoader.broadcastAnnouncement(),m&&(m.resolve(u.data,this.getBandwidth(t)),this.engineRequest=void 0),this.requests.remove(u);var h=this.config.swarmId??this.streamManifestUrl,l=getStreamSwarmId(h,n);this.segmentStorage.storeSegment(h,l,a.externalId,u.data,a.startTime,a.endTime,a.stream.type,this.streamDetails.isLive);break;case"failed":"http"!==i||d||this.p2pLoaders.currentLoader.broadcastAnnouncement(),m||n.segments.has(u.segment.runtimeId)||this.requests.remove(u),u.failedAttempts.httpAttemptsCount>=r&&m&&(this.engineRequest=void 0,m.reject());break;case"not-started":case"aborted":this.requests.remove(u)}u.markHandledByProcessQueue();var c=u.failedAttempts["lastAttempt"];c&&s-c.error.timestamp>FAILED_ATTEMPTS_CLEAR_INTERVAL&&u.failedAttempts.clear()}}processQueue(){var{queue:e,queueSegmentIds:t,queueDownloadRatio:n}=this.generateQueue(),{simultaneousHttpDownloads:r,simultaneousP2PDownloads:s,httpErrorRetries:i}=(this.processRequests(t,n),this.config);null!=(t=this.engineRequest)&&t.shouldBeStartedImmediately&&"pending"===this.engineRequest.status&&this.requests.executingHttpCount<r&&(n=this.engineRequest["segment"],(!(t=this.requests.get(n))||"not-started"===t.status||"failed"===t.status&&t.failedAttempts.httpAttemptsCount<this.config.httpErrorRetries)&&this.loadThroughHttp(n));for(const h of e){var o,{statuses:a,segment:d}=h;const l=this.requests.get(d);a.isHighDemand?"http"===(null==l?void 0:l.downloadSource)&&"loading"===l.status||"http"===(null==l?void 0:l.downloadSource)&&"failed"===l.status&&l.failedAttempts.httpAttemptsCount>=i||(o="loading"===(null==l?void 0:l.status)&&"p2p"===l.downloadSource,this.requests.executingHttpCount<r||this.abortLastHttpLoadingInQueueAfterItem(e,d)&&this.requests.executingHttpCount<r?(o&&l.abortFromProcessQueue(),this.loadThroughHttp(d)):o||(this.requests.executingP2PCount<s||this.abortLastP2PLoadingInQueueAfterItem(e,d)&&this.requests.executingP2PCount<s)&&this.loadThroughP2P(d)):a.isP2PDownloadable&&"loading"!==(null==l?void 0:l.status)&&(this.requests.executingP2PCount<s||this.p2pLoaders.currentLoader.isSegmentLoadedBySomeone(d)&&this.abortLastP2PLoadingInQueueAfterItem(e,d)&&this.requests.executingP2PCount<s)&&this.loadThroughP2P(d)}}abortSegmentRequest(e){var t;(null==(t=this.engineRequest)?void 0:t.segment.runtimeId)===e&&(this.engineRequest.abort(),this.logger("abort: ",getSegmentString(this.engineRequest.segment)),this.engineRequest=void 0,this.requestProcessQueueMicrotask())}loadThroughHttp(e){e=this.requests.getOrCreateRequest(e);new HttpRequestExecutor(e,this.config,this.eventTarget),this.p2pLoaders.currentLoader.broadcastAnnouncement()}loadThroughP2P(e){this.p2pLoaders.currentLoader.downloadSegment(e)}loadRandomThroughHttp(){var t=this.getAvailableStorageCapacityPercent();if(!(t<=10)){var{simultaneousHttpDownloads:n,httpErrorRetries:e}=this.config,r=this.p2pLoaders.currentLoader;if(!(n<=this.requests.executingHttpCount)&&r.connectedPeerCount){const h=[];for(var{segment:s,statuses:i}of generateQueue(this.lastRequestedSegment,this.playback,this.config,this.p2pLoaders.currentLoader,t)){var o=this.config.swarmId??this.streamManifestUrl,a=getStreamSwarmId(o,s.stream);!i.isHttpDownloadable||i.isP2PDownloadable||this.segmentStorage.hasSegment(o,a,s.externalId)||((i=this.requests.get(s))&&("loading"===i.status||"succeed"===i.status||e<=(i.failedAttempts.httpAttemptsCount??0))||h.push(s))}if(h.length){t=n-this.requests.executingHttpCount;if(0!=t){var d,t=r.connectedPeerCount+1,r=Math.min(h.length,n*t);let e=r/t;for(const l of shuffleArray(Array.from({length:r},(e,t)=>t))){if(n<=this.requests.executingHttpCount)break;if((1<=e||Math.random()<=e)&&(d=h[l],this.loadThroughHttp(d)),--e<=0)break}}}}}}abortLastHttpLoadingInQueueAfterItem(e,t){for(var{segment:n}of arrayBackwards(e)){if(n===t)break;const r=this.requests.get(n);if("http"===(null==r?void 0:r.downloadSource)&&"loading"===r.status)return r.abortFromProcessQueue(),!0}return!1}abortLastP2PLoadingInQueueAfterItem(e,t){for(var{segment:n}of arrayBackwards(e)){if(n===t)break;const r=this.requests.get(n);if("p2p"===(null==r?void 0:r.downloadSource)&&"loading"===r.status)return r.abortFromProcessQueue(),!0}return!1}getAvailableStorageCapacityPercent(){var{totalCapacity:e,usedCapacity:t}=this.segmentStorage.getUsage();return 100-t/e*100}generateQueue(){const e=[],t=new Set;let n=0,r=0;var s=this.getAvailableStorageCapacityPercent();for(const d of generateQueue(this.lastRequestedSegment,this.playback,this.config,this.p2pLoaders.currentLoader,s)){n++;var i=d["segment"],o=this.config.swarmId??this.streamManifestUrl,a=getStreamSwarmId(o,i.stream);this.segmentStorage.hasSegment(o,a,i.externalId)||"succeed"===(null==(o=this.requests.get(i))?void 0:o.status)?r++:(e.push(d),t.add(i.runtimeId))}return{queue:e,queueSegmentIds:t,maxPossibleLength:n,alreadyLoadedCount:r,queueDownloadRatio:0!==n?r/n:0}}getBandwidth(e){const{http:t,all:n}=this.bandwidthCalculators;var r=this.streamDetails["activeLevelBitrate"];if(0===this.streamDetails.activeLevelBitrate)return n.getBandwidthLoadingOnly(3);var s=Math.max(n.getBandwidth(30,this.levelChangedTimestamp),n.getBandwidth(60,this.levelChangedTimestamp),n.getBandwidth(90,this.levelChangedTimestamp));if(.8<=e||.9*r<=s)return Math.max(n.getBandwidthLoadingOnly(1),n.getBandwidthLoadingOnly(3),n.getBandwidthLoadingOnly(5));e=Math.max(t.getBandwidthLoadingOnly(1),t.getBandwidthLoadingOnly(3),t.getBandwidthLoadingOnly(5));return Math.max(s,e)}notifyLevelChanged(){this.levelChangedTimestamp=performance.now()}updatePlayback(e,t){var n,r=this.playback.rate!==t,s=this.playback.position!==e;(r||s)&&(n=.5<Math.abs(e-this.playback.position)/this.segmentAvgDuration,s&&(this.playback.position=e),r&&0!==t&&(this.playback.rate=t),n&&(this.logger("position significantly changed"),null!=(s=this.engineRequest)&&s.markAsShouldBeStartedImmediately()),this.segmentStorage.onPlaybackUpdated(e,t),this.requestProcessQueueMicrotask(n))}updateStream(e){e===this.lastRequestedSegment.stream&&(this.logger("update stream: "+getStreamString(e)),this.requestProcessQueueMicrotask())}destroy(){var e;clearInterval(this.storageCleanUpIntervalId),clearInterval(this.randomHttpDownloadInterval),this.storageCleanUpIntervalId=void 0,null!=(e=this.engineRequest)&&e.abort(),this.requests.destroy(),this.p2pLoaders.destroy()}}class BandwidthCalculator{constructor(e=2e4){__publicField(this,"loadingsCount",0),__publicField(this,"bytes",[]),__publicField(this,"loadingOnlyTimestamps",[]),__publicField(this,"timestamps",[]),__publicField(this,"noLoadingsTime",0),__publicField(this,"loadingsStoppedAt",0),this.clearThresholdMs=e}addBytes(e,t=performance.now()){this.bytes.push(e),this.loadingOnlyTimestamps.push(t-this.noLoadingsTime),this.timestamps.push(t)}startLoading(e=performance.now()){this.clearStale(),0===this.loadingsCount&&0!==this.loadingsStoppedAt&&(this.noLoadingsTime+=e-this.loadingsStoppedAt),this.loadingsCount++}stopLoading(e=performance.now()){0<this.loadingsCount&&(this.loadingsCount--,0===this.loadingsCount&&(this.loadingsStoppedAt=e))}getBandwidthLoadingOnly(e,t=Number.NEGATIVE_INFINITY){if(!this.loadingOnlyTimestamps.length)return 0;var n=this.loadingOnlyTimestamps[this.loadingOnlyTimestamps.length-1];let r=n;var s=n-1e3*e;let i=0;for(let e=this.bytes.length-1;0<=e;e--){var o=this.loadingOnlyTimestamps[e];if(o<s||this.timestamps[e]<t)break;r=o,i+=this.bytes[e]}return 8e3*i/(n-r)}getBandwidth(e,t=Number.NEGATIVE_INFINITY,n=performance.now()){if(!this.timestamps.length)return 0;var r=n-1e3*e;let s=n,i=0;for(let e=this.bytes.length-1;0<=e;e--){var o=this.timestamps[e];if(o<r||o<t)break;s=o,i+=this.bytes[e]}return 8e3*i/(n-s)}clearStale(){if(this.loadingOnlyTimestamps.length){var t=this.loadingOnlyTimestamps[this.loadingOnlyTimestamps.length-1]-this.clearThresholdMs;let e=0;for(const n of this.loadingOnlyTimestamps){if(n>t)break;e++}this.bytes.splice(0,e),this.loadingOnlyTimestamps.splice(0,e),this.timestamps.splice(0,e)}}}const getStorageItemId=(e,t)=>e+"|"+t,isAndroid=e=>/Android/i.test(e),isIPadOrIPhone=e=>/iPad|iPhone/i.test(e),isAndroidWebview=e=>/Android/i.test(e)&&!/Chrome|Firefox/i.test(e),BYTES_PER_MiB=1048576;class SegmentMemoryStorage{constructor(){__publicField(this,"userAgent",navigator.userAgent),__publicField(this,"segmentMemoryStorageLimit",4096),__publicField(this,"currentStorageUsage",0),__publicField(this,"cache",new Map),__publicField(this,"logger"),__publicField(this,"coreConfig"),__publicField(this,"mainStreamConfig"),__publicField(this,"secondaryStreamConfig"),__publicField(this,"currentPlayback"),__publicField(this,"lastRequestedSegment"),__publicField(this,"segmentChangeCallback"),this.logger=debug$3("p2pml-core:segment-memory-storage"),this.logger.color="RebeccaPurple"}async initialize(e,t,n){this.coreConfig=e,this.mainStreamConfig=t,this.secondaryStreamConfig=n,this.setMemoryStorageLimit(),this.logger("initialized")}onPlaybackUpdated(e,t){this.currentPlayback={position:e,rate:t}}onSegmentRequested(e,t,n,r,s,i,o){this.lastRequestedSegment={streamId:t,segmentId:n,startTime:r,endTime:s,swarmId:e,streamType:i,isLiveStream:o}}async storeSegment(e,t,n,r,s,i,o,a){this.clear(a,r.byteLength);a=getStorageItemId(t,n);if(this.cache.set(a,{data:r,segmentId:n,streamId:t,startTime:s,endTime:i,streamType:o}),this.increaseStorageUsage(r.byteLength),this.logger(`add segment: ${n} to `+t),!this.segmentChangeCallback)throw new Error("dispatchStorageUpdatedEvent is not set");this.segmentChangeCallback(t)}async getSegmentData(e,t,n){t=getStorageItemId(t,n),n=this.cache.get(t);if(void 0!==n)return n.data}getUsage(){if(!this.lastRequestedSegment||!this.currentPlayback)return{totalCapacity:this.segmentMemoryStorageLimit,usedCapacity:this.currentStorageUsage};var e,t,n=this.currentPlayback.position;let r=0;for({endTime:e,data:t}of this.cache.values())n>e||(r+=t.byteLength);return{totalCapacity:this.segmentMemoryStorageLimit,usedCapacity:r/BYTES_PER_MiB}}hasSegment(e,t,n){t=getStorageItemId(t,n);return void 0!==this.cache.get(t)}getStoredSegmentIds(e,t){const n=[];for(var{segmentId:r,streamId:s}of this.cache.values())s===t&&n.push(r);return n}clear(e,t){if(this.currentPlayback&&this.mainStreamConfig&&this.secondaryStreamConfig&&this.coreConfig&&(this.isMemoryLimitReached(t)||e)){const a=new Set;for(const d of Array.from(this.cache.values()).sort((e,t)=>e.startTime-t.startTime)){var{streamId:n,segmentId:r,data:s}=d,i=getStorageItemId(n,r),o=this.shouldRemoveSegment(d,e,this.currentPlayback.position);if(o&&(this.cache.delete(i),a.add(n),this.decreaseStorageUsage(s.byteLength),this.logger(`Removed segment ${r} from stream `+n),!this.isMemoryLimitReached(t)&&!e))break}this.sendUpdatesToAffectedStreams(a)}}isMemoryLimitReached(e){return this.currentStorageUsage+e/BYTES_PER_MiB>this.segmentMemoryStorageLimit}setSegmentChangeCallback(e){this.segmentChangeCallback=e}sendUpdatesToAffectedStreams(e){0!==e.size&&e.forEach(e=>{if(!this.segmentChangeCallback)throw new Error("dispatchStorageUpdatedEvent is not set");this.segmentChangeCallback(e)})}shouldRemoveSegment(e,t,n){var{endTime:e,streamType:r}=e,r=this.getStreamTimeWindow(r,"highDemandTimeWindow");return!(n<=e)&&(!t||r+e<n)}increaseStorageUsage(e){this.currentStorageUsage+=e/BYTES_PER_MiB}decreaseStorageUsage(e){this.currentStorageUsage-=e/BYTES_PER_MiB}setMemoryStorageLimit(){this.coreConfig&&this.coreConfig.segmentMemoryStorageLimit?this.segmentMemoryStorageLimit=this.coreConfig.segmentMemoryStorageLimit:isAndroidWebview(this.userAgent)||isIPadOrIPhone(this.userAgent)?this.segmentMemoryStorageLimit=1024:isAndroid(this.userAgent)&&(this.segmentMemoryStorageLimit=2048)}getStreamTimeWindow(e,t){e="main"===e?this.mainStreamConfig:this.secondaryStreamConfig;return(null==e?void 0:e[t])??0}destroy(){this.cache.clear()}}class EventTarget{constructor(){__publicField(this,"events",new Map)}dispatchEvent(e,...t){e=this.events.get(e);if(e)for(const n of e)n(...t)}getEventDispatcher(e){let t=this.events.get(e);t||(t=[],this.events.set(e,t));const n=t;return(...e)=>{for(const t of n)t(...e)}}addEventListener(e,t){const n=this.events.get(e);n?n.push(t):this.events.set(e,[t])}removeEventListener(e,t){const n=this.events.get(e);n&&-1!==(e=n.indexOf(t))&&n.splice(e,1)}}const _Core=class _Core{constructor(e){__publicField(this,"eventTarget",new EventTarget),__publicField(this,"manifestResponseUrl"),__publicField(this,"streams",new Map),__publicField(this,"mainStreamConfig"),__publicField(this,"secondaryStreamConfig"),__publicField(this,"commonCoreConfig"),__publicField(this,"bandwidthCalculators",{all:new BandwidthCalculator,http:new BandwidthCalculator}),__publicField(this,"segmentStorage"),__publicField(this,"mainStreamLoader"),__publicField(this,"secondaryStreamLoader"),__publicField(this,"streamDetails",{isLive:!1,activeLevelBitrate:0});e=filterUndefinedProps(e??{});this.commonCoreConfig=mergeAndFilterConfig({defaultConfig:_Core.DEFAULT_COMMON_CORE_CONFIG,baseConfig:e}),this.mainStreamConfig=mergeAndFilterConfig({defaultConfig:_Core.DEFAULT_STREAM_CONFIG,baseConfig:e,specificStreamConfig:null==e?void 0:e.mainStream}),this.secondaryStreamConfig=mergeAndFilterConfig({defaultConfig:_Core.DEFAULT_STREAM_CONFIG,baseConfig:e,specificStreamConfig:null==e?void 0:e.secondaryStream})}getConfig(){return{...deepCopy(this.commonCoreConfig),mainStream:deepCopy(this.mainStreamConfig),secondaryStream:deepCopy(this.secondaryStreamConfig)}}applyDynamicConfig(e){var{mainStream:t,secondaryStream:n}=e;this.overrideAllConfigs(e,t,n),this.mainStreamConfig.isP2PDisabled&&this.destroyStreamLoader("main"),this.secondaryStreamConfig.isP2PDisabled&&this.destroyStreamLoader("secondary")}addEventListener(e,t){this.eventTarget.addEventListener(e,t)}removeEventListener(e,t){this.eventTarget.removeEventListener(e,t)}setManifestResponseUrl(e){this.manifestResponseUrl=e.split("?")[0]}hasSegment(e){return!!getSegmentFromStreamsMap(this.streams,e)}getStream(e){return this.streams.get(e)}addStreamIfNoneExists(e){this.streams.has(e.runtimeId)||this.streams.set(e.runtimeId,{...e,segments:new Map})}updateStream(e,t,n){const r=this.streams.get(e);if(r){if(t)for(const s of t)r.segments.has(s.runtimeId)||r.segments.set(s.runtimeId,{...s,stream:r});if(n)for(const i of n)r.segments.delete(i);null!=(e=this.mainStreamLoader)&&e.updateStream(r),null!=(t=this.secondaryStreamLoader)&&t.updateStream(r)}}async loadSegment(e,t){if(!this.manifestResponseUrl)throw new Error("Manifest response url is not defined");await this.initializeSegmentStorage();e=this.identifySegment(e);const n=this.getStreamHybridLoader(e);n.loadSegment(e,t)}abortSegmentLoading(e){var t;null!=(t=this.mainStreamLoader)&&t.abortSegmentRequest(e),null!=(t=this.secondaryStreamLoader)&&t.abortSegmentRequest(e)}updatePlayback(e,t){var n;null!=(n=this.mainStreamLoader)&&n.updatePlayback(e,t),null!=(n=this.secondaryStreamLoader)&&n.updatePlayback(e,t)}setActiveLevelBitrate(e){e!==this.streamDetails.activeLevelBitrate&&(this.streamDetails.activeLevelBitrate=e,null!=(e=this.mainStreamLoader)&&e.notifyLevelChanged(),null!=(e=this.secondaryStreamLoader)&&e.notifyLevelChanged())}setIsLive(e){this.streamDetails.isLive=e}isSegmentLoadable(e){try{var t=this.identifySegment(e);return"main"===t.stream.type&&this.mainStreamConfig.isP2PDisabled?!1:"secondary"!==t.stream.type||!this.secondaryStreamConfig.isP2PDisabled}catch{return!1}}destroy(){var e;this.streams.clear(),null!=(e=this.mainStreamLoader)&&e.destroy(),null!=(e=this.secondaryStreamLoader)&&e.destroy(),null!=(e=this.segmentStorage)&&e.destroy(),this.mainStreamLoader=void 0,this.secondaryStreamLoader=void 0,this.segmentStorage=void 0,this.manifestResponseUrl=void 0,this.streamDetails={isLive:!1,activeLevelBitrate:0}}async initializeSegmentStorage(){if(!this.segmentStorage){var e=this.streamDetails.isLive;const t=this.commonCoreConfig.customSegmentStorageFactory;if(t&&"function"!=typeof t)throw new Error("Storage configuration is invalid");const n=t?t(e):new SegmentMemoryStorage;await n.initialize(this.commonCoreConfig,this.mainStreamConfig,this.secondaryStreamConfig),this.segmentStorage=n}}identifySegment(e){if(!this.manifestResponseUrl)throw new Error("Manifest response url is undefined");var t=getSegmentFromStreamsMap(this.streams,e);if(t)return t;throw new Error("Not found segment with id: "+e)}overrideAllConfigs(e,t,n){overrideConfig(this.commonCoreConfig,e),overrideConfig(this.mainStreamConfig,e),overrideConfig(this.secondaryStreamConfig,e),t&&overrideConfig(this.mainStreamConfig,t),n&&overrideConfig(this.secondaryStreamConfig,n)}destroyStreamLoader(e){"main"===e?(null!=(e=this.mainStreamLoader)&&e.destroy(),this.mainStreamLoader=void 0):(null!=(e=this.secondaryStreamLoader)&&e.destroy(),this.secondaryStreamLoader=void 0)}getStreamHybridLoader(e){return"main"===e.stream.type?(this.mainStreamLoader??(this.mainStreamLoader=this.createNewHybridLoader(e)),this.mainStreamLoader):(this.secondaryStreamLoader??(this.secondaryStreamLoader=this.createNewHybridLoader(e)),this.secondaryStreamLoader)}createNewHybridLoader(e){if(!this.manifestResponseUrl)throw new Error("Manifest response url is not defined");if(!this.segmentStorage)throw new Error("Segment storage is not initialized");var t="main"===e.stream.type?this.mainStreamConfig:this.secondaryStreamConfig;return new HybridLoader(this.manifestResponseUrl,e,this.streamDetails,t,this.bandwidthCalculators,this.segmentStorage,this.eventTarget)}};__publicField(_Core,"DEFAULT_COMMON_CORE_CONFIG",{segmentMemoryStorageLimit:void 0,customSegmentStorageFactory:void 0}),__publicField(_Core,"DEFAULT_STREAM_CONFIG",{isP2PDisabled:!1,simultaneousHttpDownloads:2,simultaneousP2PDownloads:3,highDemandTimeWindow:15,httpDownloadTimeWindow:3e3,p2pDownloadTimeWindow:6e3,webRtcMaxMessageSize:65535,p2pNotReceivingBytesTimeoutMs:2e3,p2pInactiveLoaderDestroyTimeoutMs:3e4,httpNotReceivingBytesTimeoutMs:3e3,httpErrorRetries:3,p2pErrorRetries:3,trackerClientVersionPrefix:TRACKER_CLIENT_VERSION_PREFIX,announceTrackers:["wss://tracker.novage.com.ua","wss://tracker.webtorrent.dev","wss://tracker.openwebtorrent.com"],rtcConfig:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:global.stun.twilio.com:3478"}]},validateP2PSegment:void 0,httpRequestSetup:void 0,swarmId:void 0});let Core=_Core;const debug$4=browserExports.debug;export{Core,CoreRequestError,RequestError,debug$4 as debug};